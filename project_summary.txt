--- PROJECT STRUCTURE & CODE SUMMARY ---

=== FILE TREE ===
config\db.js
controllers\adminController.js
controllers\authController.js
controllers\couponAdminController.js
controllers\couponController.js
controllers\inventoryController.js
controllers\loyaltyController.js
controllers\newsController.js
controllers\rankController.js
controllers\settingsController.js
controllers\shopController.js
controllers\userController.js
middleware\adminMiddleware.js
middleware\authMiddleware.js
package.json
routes\adminRoutes.js
routes\authRoutes.js
routes\couponAdminRoutes.js
routes\couponRoutes.js
routes\inventoryRoutes.js
routes\loyaltyRoutes.js
routes\newsRoutes.js
routes\rankRoutes.js
routes\settingsRoutes.js
routes\shopRoutes.js
routes\userRoutes.js
server.js
utils\referralCodec.js
utils\rewardSystem.js

=========================================


vvvvvvvvvv FILE START: config\db.js vvvvvvvvvv
const sql = require('mssql');
require('dotenv').config();

// Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ù† Ù…Ù„Ù .env
const config = {
    user: process.env.DB_USER,
    password: process.env.DB_PASS,
    server: process.env.DB_SERVER, 
    database: process.env.DB_NAME,
    options: {
        encrypt: false, // Ø§Ø¬Ø¹Ù„Ù‡ true Ø¥Ø°Ø§ ÙƒÙ†Øª ØªØ³ØªØ®Ø¯Ù… Azure Cloud
        trustServerCertificate: true, // Ø¶Ø±ÙˆØ±ÙŠ Ø¬Ø¯Ø§Ù‹ Ù„Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ù…Ø­Ù„ÙŠ (Localhost)
        enableArithAbort: true
    }
};

// Ø¥Ù†Ø´Ø§Ø¡ "Ù…Ø³Ø¨Ø­ Ø§ØªØµØ§Ù„" (Connection Pool) Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø³Ø±Ø¹Ø© ÙˆØ¹Ø¯Ù… Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„
const poolPromise = new sql.ConnectionPool(config)
    .connect()
    .then(pool => {
        console.log('âœ… Connected to SQL Server (AdrenalineWeb) Successfully!');
        return pool;
    })
    .catch(err => {
        console.error('âŒ Database Connection Failed! Error: ', err);
        process.exit(1); // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø³ÙŠØ±ÙØ± ÙÙŠ Ø­Ø§Ù„ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„
    });

module.exports = {
    sql,
    poolPromise
};
^^^^^^^^^^ FILE END: config\db.js ^^^^^^^^^^

vvvvvvvvvv FILE START: controllers\adminController.js vvvvvvvvvv
const { poolPromise, sql } = require('../config/db');

// 1. Ø­Ø¸Ø± Ù„Ø§Ø¹Ø¨ (Ban Player)
exports.banPlayer = async (req, res) => {
    const { targetUserNo, reason } = req.body;
    const adminName = req.user.userId;

    try {
        const pool = await poolPromise;
        const transaction = new sql.Transaction(pool);
        await transaction.begin();

        try {
            const request = new sql.Request(transaction);

            // Ø£. ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø­Ø¸Ø± ÙÙŠ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ø£ØµÙ„ÙŠ (AuthDB)
            // (Ù‡Ø°Ø§ Ù…Ø§ ÙŠÙ…Ù†Ø¹Ù‡ Ù…Ù† Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù„Ø¹Ø¨Ø©)
            await request.query(`UPDATE AuthDB.dbo.T_Account SET IsBanned = 1 WHERE UserNo = ${targetUserNo}`);

            // Ø¨. ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªÙØ§ØµÙŠÙ„ ÙÙŠ Ù…ÙˆÙ‚Ø¹Ù†Ø§ (Ù„Ù„Ø¹Ø±Ø¶)
            await request.input('uid', targetUserNo)
                         .input('reason', reason)
                         .input('admin', adminName)
                         .query(`
                            INSERT INTO AdrenalineWeb.dbo.Web_BanLog (UserNo, Reason, BannedBy, IsActive)
                            VALUES (@uid, @reason, @admin, 1)
                         `);

            await transaction.commit();
            res.json({ status: 'success', message: 'ØªÙ… Ø­Ø¸Ø± Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø¨Ù†Ø¬Ø§Ø­' });

        } catch (err) {
            await transaction.rollback();
            throw err;
        }
    } catch (err) {
        res.status(500).json({ message: 'ÙØ´Ù„ Ø§Ù„Ø­Ø¸Ø±', error: err.message });
    }
};

// 2. Ø¹Ø±Ø¶ Ø·Ù„Ø¨Ø§Øª ÙÙƒ Ø§Ù„Ø­Ø¸Ø± (Unban Requests)
exports.getUnbanRequests = async (req, res) => {
    try {
        const pool = await poolPromise;
        const result = await pool.request().query(`
            SELECT 
                R.RequestID, R.UserNo, R.FineAmount, R.PaymentType, R.RequestDate,
                U.UserId AS Username,
                (SELECT TOP 1 Nickname FROM GameDB.dbo.T_User WHERE UserNo = R.UserNo) AS Nickname,
                (SELECT TOP 1 Reason FROM AdrenalineWeb.dbo.Web_BanLog WHERE UserNo = R.UserNo AND IsActive = 1 ORDER BY BanID DESC) AS BanReason
            FROM AdrenalineWeb.dbo.Web_UnbanRequests R
            JOIN AuthDB.dbo.T_Account U ON R.UserNo = U.UserNo
            WHERE R.Status = 'Pending'
            ORDER BY R.RequestDate ASC
        `);

        res.json({ status: 'success', requests: result.recordset });
    } catch (err) {
        res.status(500).json({ message: 'Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø·Ù„Ø¨Ø§Øª', error: err.message });
    }
};

// 3. Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø·Ù„Ø¨ ÙÙƒ Ø§Ù„Ø­Ø¸Ø± (Approve & Deduct Money)
exports.approveUnban = async (req, res) => {
    const { requestId } = req.body;
    
    try {
        const pool = await poolPromise;
        
        // Ø£. Ø¬Ù„Ø¨ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨
        const reqResult = await pool.request()
            .input('rid', requestId)
            .query('SELECT * FROM AdrenalineWeb.dbo.Web_UnbanRequests WHERE RequestID = @rid');
            
        const banRequest = reqResult.recordset[0];
        if (!banRequest || banRequest.Status !== 'Pending') {
            return res.status(404).json({ message: 'Ø§Ù„Ø·Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ø£Ùˆ ØªÙ…Øª Ù…Ø¹Ø§Ù„Ø¬ØªÙ‡ Ù…Ø³Ø¨Ù‚Ø§Ù‹' });
        }

        // Ø¨. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø±ØµÙŠØ¯ Ø§Ù„Ù„Ø§Ø¹Ø¨ (Ù‡Ù„ ÙŠÙ…Ù„Ùƒ Ù‚ÙŠÙ…Ø© Ø§Ù„ØºØ±Ø§Ù…Ø©ØŸ)
        // Ù…Ù„Ø§Ø­Ø¸Ø©: Ù†ÙØªØ±Ø¶ Ø§Ù„Ø¯ÙØ¹ Ø¨Ù€ GP (GameMoney)
        const userCheck = await pool.request()
            .input('uid', banRequest.UserNo)
            .query('SELECT GameMoney FROM GameDB.dbo.T_User WHERE UserNo = @uid');
            
        const currentMoney = userCheck.recordset[0].GameMoney;

        if (currentMoney < banRequest.FineAmount) {
            return res.status(400).json({ message: 'Ø§Ù„Ù„Ø§Ø¹Ø¨ Ù„Ø§ ÙŠÙ…Ù„Ùƒ Ø±ØµÙŠØ¯Ø§Ù‹ ÙƒØ§ÙÙŠØ§Ù‹ Ù„Ø¯ÙØ¹ Ø§Ù„ØºØ±Ø§Ù…Ø©' });
        }

        // Ø¬. ØªÙ†ÙÙŠØ° Ø§Ù„Ø¹Ù…Ù„ÙŠØ©: Ø®ØµÙ… Ø§Ù„Ù…Ø§Ù„ + ÙÙƒ Ø§Ù„Ø­Ø¸Ø±
        const transaction = new sql.Transaction(pool);
        await transaction.begin();

        try {
            const request = new sql.Request(transaction);

            // 1. Ø®ØµÙ… Ø§Ù„ØºØ±Ø§Ù…Ø©
            await request.query(`
                UPDATE GameDB.dbo.T_User 
                SET GameMoney = GameMoney - ${banRequest.FineAmount} 
                WHERE UserNo = ${banRequest.UserNo}
            `);

            // 2. ÙÙƒ Ø§Ù„Ø­Ø¸Ø± ÙÙŠ AuthDB
            await request.query(`UPDATE AuthDB.dbo.T_Account SET IsBanned = 0 WHERE UserNo = ${banRequest.UserNo}`);

            // 3. ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨
            await request.query(`UPDATE AdrenalineWeb.dbo.Web_UnbanRequests SET Status = 'Approved' WHERE RequestID = ${requestId}`);

            // 4. Ø¥ØºÙ„Ø§Ù‚ Ø³Ø¬Ù„ Ø§Ù„Ø­Ø¸Ø±
            await request.query(`UPDATE AdrenalineWeb.dbo.Web_BanLog SET IsActive = 0 WHERE UserNo = ${banRequest.UserNo}`);

            await transaction.commit();
            res.json({ status: 'success', message: 'ØªÙ… ÙÙƒ Ø§Ù„Ø­Ø¸Ø± ÙˆØ®ØµÙ… Ø§Ù„ØºØ±Ø§Ù…Ø© Ø¨Ù†Ø¬Ø§Ø­' });

        } catch (err) {
            await transaction.rollback();
            throw err;
        }

    } catch (err) {
        res.status(500).json({ message: 'ÙØ´Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©', error: err.message });
    }
    // ... (Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø³Ø§Ø¨Ù‚: banPlayer, unban, etc...)

// ğŸ†• ØªØºÙŠÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø¨Ø§Ù„Ù‚ÙˆØ© (Ù„Ù„Ø£Ø¯Ù…Ù† ÙÙ‚Ø·)
exports.forceChangeCredentials = async (req, res) => {
    // Ù†Ø·Ù„Ø¨: Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØŒ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ: Ø¨Ø§Ø³ÙˆØ±Ø¯ Ø¬Ø¯ÙŠØ¯)ØŒ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ: Ø¥ÙŠÙ…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯)
    const { targetUsername, newPassword, newEmail } = req.body;

    if (!targetUsername) {
        return res.status(400).json({ message: 'ÙŠØ¬Ø¨ ØªØ­Ø¯ÙŠØ¯ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Target Username)' });
    }

    if (!newPassword && !newEmail) {
        return res.status(400).json({ message: 'ÙŠØ¬Ø¨ Ø¥Ø±Ø³Ø§Ù„ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø¬Ø¯ÙŠØ¯Ø© Ø£Ùˆ Ø¥ÙŠÙ…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯ Ù„ØªØºÙŠÙŠØ±Ù‡' });
    }

    try {
        const pool = await poolPromise;

        // 1. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù„Ø§Ø¹Ø¨
        const userCheck = await pool.request()
            .input('uid', targetUsername)
            .query("SELECT UserNo FROM AuthDB.dbo.T_Account WHERE UserId = @uid");

        if (userCheck.recordset.length === 0) {
            return res.status(404).json({ message: 'Ù‡Ø°Ø§ Ø§Ù„Ù„Ø§Ø¹Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯' });
        }

        const targetUserNo = userCheck.recordset[0].UserNo;

        // 2. ØªØºÙŠÙŠØ± Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ (Ø¥Ø°Ø§ ØªÙ… Ø¥Ø±Ø³Ø§Ù„Ù‡)
        if (newEmail) {
            // Ø§Ù„ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ ØºÙŠØ± Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ù‚Ø¨Ù„ Ø´Ø®Øµ Ø¢Ø®Ø±
            const emailCheck = await pool.request()
                .input('email', newEmail)
                .input('uid', targetUserNo) // Ø§Ø³ØªØ«Ù†Ø§Ø¡ Ø§Ù„Ù„Ø§Ø¹Ø¨ Ù†ÙØ³Ù‡
                .query("SELECT UserNo FROM AuthDB.dbo.T_Account WHERE Email = @email AND UserNo != @uid");

            if (emailCheck.recordset.length > 0) {
                return res.status(400).json({ message: 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø­Ø³Ø§Ø¨ Ø¢Ø®Ø±' });
            }

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ + ØªÙØ¹ÙŠÙ„Ù‡ ÙÙˆØ±Ø§Ù‹ (Ù„Ø£Ù† Ø§Ù„Ø£Ø¯Ù…Ù† Ù‡Ùˆ Ù…Ù† Ù‚Ø§Ù… Ø¨Ø§Ù„ØªØºÙŠÙŠØ±)
            await pool.request()
                .input('email', newEmail)
                .input('uid', targetUserNo)
                .query("UPDATE AuthDB.dbo.T_Account SET Email = @email, IsEmailVerified = 1, VerificationToken = NULL WHERE UserNo = @uid");
        }

        // 3. ØªØºÙŠÙŠØ± Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯ (Ø¥Ø°Ø§ ØªÙ… Ø¥Ø±Ø³Ø§Ù„Ù‡)
        if (newPassword) {
            await pool.request()
                .input('pass', newPassword)
                .input('uid', targetUserNo)
                .query("UPDATE AuthDB.dbo.T_Account SET Password = @pass, PasswordResetToken = NULL WHERE UserNo = @uid");
        }

        res.json({ 
            status: 'success', 
            message: `ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù„Ø§Ø¹Ø¨ [${targetUsername}] Ø¨Ù†Ø¬Ø§Ø­.`,
            details: {
                emailUpdated: newEmail ? true : false,
                passwordUpdated: newPassword ? true : false
            }
        });

    } catch (err) {
        console.error(err);
        res.status(500).json({ message: 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ«', error: err.message });
    }
};
};
^^^^^^^^^^ FILE END: controllers\adminController.js ^^^^^^^^^^

vvvvvvvvvv FILE START: controllers\authController.js vvvvvvvvvv
const { poolPromise, sql } = require('../config/db');
const jwt = require('jsonwebtoken');
const nodemailer = require('nodemailer');
const { v4: uuidv4 } = require('uuid');
const { decodeReferralCode } = require('../utils/referralCodec');
require('dotenv').config(); // ğŸ‘ˆ Ù…Ù‡Ù… Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ ÙˆØ§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯ Ù…Ù† Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø³Ø±ÙŠ

const JWT_SECRET = process.env.JWT_SECRET || 'super_secret_adrenaline_key_2026';

// ğŸ“§ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ (ÙŠÙ‚Ø±Ø£ Ø§Ù„Ø¢Ù† Ù…Ù† Ù…Ù„Ù .env)
const transporter = nodemailer.createTransport({
    service: 'gmail',
    auth: {
        user: process.env.EMAIL_USER, // ÙŠÙ‚Ø±Ø£ Ù…Ù† Ù…Ù„Ù .env
        pass: process.env.EMAIL_PASS  // ÙŠÙ‚Ø±Ø£ Ù…Ù† Ù…Ù„Ù .env
    },
    tls: {
        rejectUnauthorized: false // ÙŠØ³Ø§Ø¹Ø¯ ÙÙŠ ØªØ¬Ù†Ø¨ Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ø§ØªØµØ§Ù„
    }
});

// 1. ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ (Login) - (ØªÙ… ØªØ¹Ø¯ÙŠÙ„Ù‡ Ù„ÙŠØ¯Ø¹Ù… Ù…ÙŠØ²Ø© ØªØºÙŠÙŠØ± Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„)
exports.login = async (req, res) => {
    const { username, password } = req.body;

    if (!username || !password) {
        return res.status(400).json({ message: 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±' });
    }

    try {
        const pool = await poolPromise;
        const result = await pool.request()
            .input('uid', username)
            .query(`
                SELECT A.UserNo, A.UserId, A.Password, A.IsBanned, A.IsEmailVerified, A.Email, -- ğŸ‘ˆ Ø£Ø¶ÙÙ†Ø§ Email Ù‡Ù†Ø§
                       U.GMGrade, U.Nickname 
                FROM AuthDB.dbo.T_Account A
                LEFT JOIN GameDB.dbo.T_User U ON A.UserNo = U.UserNo 
                WHERE A.UserId = @uid
            `);

        const user = result.recordset[0];

        if (!user) return res.status(404).json({ message: 'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯' });
        if (user.Password !== password) return res.status(401).json({ message: 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©' });
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ (Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯)
        if (user.IsEmailVerified === false) {
            return res.status(403).json({ 
                message: 'ÙŠØ¬Ø¨ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø£ÙˆÙ„Ø§Ù‹. Ø±Ø§Ø¬Ø¹ ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„ÙˆØ§Ø±Ø¯.',
                errorType: 'NOT_VERIFIED', // ÙƒÙˆØ¯ Ù„ÙŠØ³ØªØ®Ø¯Ù…Ù‡ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø£Ø²Ø±Ø§Ø±
                currentEmail: user.Email   // Ù†Ø±Ø³Ù„ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù„ÙŠØ¹Ø±Ù Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø£ÙŠÙ† Ø§Ù„Ø®Ø·Ø£
            });
        }

        const isBanned = user.IsBanned === 1 || user.IsBanned === true;
        const token = jwt.sign(
            { userNo: user.UserNo, userId: user.UserId, isAdmin: user.GMGrade >= 1, isBanned: isBanned },
            JWT_SECRET, { expiresIn: '24h' }
        );

        res.json({
            status: 'success',
            message: 'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­',
            token: token,
            user: {
                userNo: user.UserNo,
                username: user.UserId,
                nickname: user.Nickname || null,
                isGM: user.GMGrade >= 1,
                isBanned: isBanned
            }
        });
    } catch (err) {
        console.error(err);
        res.status(500).json({ message: 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ±', error: err.message });
    }
};

// 2. Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯ (Register) - (ÙƒÙ…Ø§ Ù‡Ùˆ ØªÙ…Ø§Ù…Ø§Ù‹ ÙÙŠ Ù†Ø³Ø®ØªÙƒ)
exports.register = async (req, res) => {
    // ğŸ‘‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‡Ù†Ø§: Ø§Ø³ØªØ®Ø¯Ø§Ù… userid Ùˆ referralCode Ù„ÙŠØ·Ø§Ø¨Ù‚ Postman
    const { userid, password, email, referralCode } = req.body;

    console.log('Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„:', req.body); // Ù„Ù„ØªØ£ÙƒØ¯ ÙÙŠ Ø§Ù„ÙƒÙˆÙ†Ø³ÙˆÙ„

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø¨Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
    if (!userid || !password || !email) {
        return res.status(400).json({ message: 'Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©: ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø±Ø³Ø§Ù„ userid, password, email' });
    }

    try {
        const pool = await poolPromise;

        // 1. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙƒØ±Ø§Ø±
        const check = await pool.request()
            .input('uid', userid)
            .input('email', email)
            .query('SELECT UserId FROM AuthDB.dbo.T_Account WHERE UserId = @uid OR Email = @email');
        
        if (check.recordset.length > 0) {
            return res.status(400).json({ message: 'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ø§Ù‹' });
        }

        // 2. Ù…Ø¹Ø§Ù„Ø¬Ø© ÙƒÙˆØ¯ Ø§Ù„Ø¯Ø¹ÙˆØ© (ØªØ­ÙˆÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù†ØµÙŠ Ø¥Ù„Ù‰ Ø±Ù‚Ù…)
        let referrerUserNo = null;
        if (referralCode) {
            const decodedId = decodeReferralCode(referralCode);
            if (decodedId) {
                // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ø¯Ø§Ø¹ÙŠ Ù…ÙˆØ¬ÙˆØ¯ ÙØ¹Ù„Ø§Ù‹
                const refCheck = await pool.request().query(`SELECT UserNo FROM AuthDB.dbo.T_Account WHERE UserNo = ${decodedId}`);
                if (refCheck.recordset.length > 0) {
                    referrerUserNo = decodedId;
                }
            }
        }

        // 3. Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        const verificationToken = require('crypto').randomBytes(32).toString('hex');

        await pool.request()
            .input('uid', userid)
            .input('pass', password) 
            .input('email', email)
            .input('token', verificationToken)
            .input('ref', referrerUserNo) // ğŸ‘ˆ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¯Ø§Ø¹ÙŠ
            .query(`
                INSERT INTO AuthDB.dbo.T_Account 
                (UserId, Password, Email, IsEmailVerified, VerificationToken, ReferredBy, RegDate, IsBanned)
                VALUES 
                (@uid, @pass, @email, 0, @token, @ref, GETDATE(), 0)
            `);

        res.json({ status: 'success', message: 'ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­!' });

    } catch (err) {
        console.error(err);
        res.status(500).json({ message: 'ÙØ´Ù„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„', error: err.message });
    }
};

// 3. ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ (ÙƒÙ…Ø§ Ù‡Ùˆ ÙÙŠ Ù†Ø³Ø®ØªÙƒ)
// ØªØ­Ø¯ÙŠØ«: Ø¯Ø§Ù„Ø© ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ + Ù…ÙƒØ§ÙØ£Ø© Ø§Ù„Ø¯Ø§Ø¹ÙŠ
exports.verifyEmail = async (req, res) => {
    const { token } = req.query;

    if (!token) return res.status(400).json({ message: 'Ø±Ù…Ø² Ø§Ù„ØªÙØ¹ÙŠÙ„ Ù…ÙÙ‚ÙˆØ¯' });

    try {
        const pool = await poolPromise;

        // 1. Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù„Ø§Ø¹Ø¨ ÙˆØ§Ù„Ø¯Ø§Ø¹ÙŠ
        const checkResult = await pool.request()
            .input('token', token)
            .query(`
                SELECT UserNo, UserId, IsEmailVerified, ReferredBy 
                FROM AuthDB.dbo.T_Account 
                WHERE VerificationToken = @token
            `);

        const user = checkResult.recordset[0];

        if (!user) return res.status(400).json({ message: 'Ø±Ø§Ø¨Ø· Ø§Ù„ØªÙØ¹ÙŠÙ„ ØºÙŠØ± ØµØ§Ù„Ø­' });
        if (user.IsEmailVerified) return res.status(400).json({ message: 'Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…ÙØ¹Ù„ Ù…Ø³Ø¨Ù‚Ø§Ù‹' });

        // 2. Ø¨Ø¯Ø¡ Ø§Ù„ØªÙØ¹ÙŠÙ„
        const transaction = new sql.Transaction(pool);
        await transaction.begin();

        try {
            const request = new sql.Request(transaction);

            // Ø£. ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨
            await request.query(`
                UPDATE AuthDB.dbo.T_Account 
                SET IsEmailVerified = 1, VerificationToken = NULL 
                WHERE UserNo = ${user.UserNo}
            `);

            // Ø¨. Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ÙƒØ§ÙØ£Ø© (Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø¯Ø§Ø¹ÙŠ)
            if (user.ReferredBy && user.ReferredBy > 0) {
                
                // Ø¬Ù„Ø¨ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª + Ø¹Ø¯Ø¯ Ø§Ù„Ø¯Ø¹ÙˆØ§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù„Ù„Ø¯Ø§Ø¹ÙŠ
                const inviteCheck = await request.query(`
                    SELECT 
                        (SELECT COUNT(*) FROM AuthDB.dbo.T_Account WHERE ReferredBy = ${user.ReferredBy} AND IsEmailVerified = 1) AS CurrentInvites,
                        (SELECT ConfigValue FROM AdrenalineWeb.dbo.Web_Settings WHERE ConfigKey = 'ReferralMaxCount') AS MaxLimit,
                        (SELECT ConfigValue FROM AdrenalineWeb.dbo.Web_Settings WHERE ConfigKey = 'ReferralRewardPoints') AS PointsVal
                `);

                const currentInvites = inviteCheck.recordset[0].CurrentInvites;
                const maxLimit = parseInt(inviteCheck.recordset[0].MaxLimit) || 50;
                const rewardPoints = parseInt(inviteCheck.recordset[0].PointsVal) || 10;

                // Ø§Ù„ØªØ­Ù‚Ù‚: Ù‡Ù„ ÙˆØµÙ„ Ù„Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ØŸ
                if (currentInvites < maxLimit) {
                    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù†Ù‚Ø§Ø· Ù„Ù„Ø¯Ø§Ø¹ÙŠ
                    await request.query(`
                        UPDATE AuthDB.dbo.T_Account 
                        SET LoyaltyPoints = LoyaltyPoints + ${rewardPoints} 
                        WHERE UserNo = ${user.ReferredBy}
                    `);

                    // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
                    await request.query(`
                        INSERT INTO AdrenalineWeb.dbo.Web_LoyaltyLog (UserNo, PointsSpent, RewardType, RewardAmount, Date)
                        VALUES (${user.ReferredBy}, 0, 'REFERRAL_REWARD', ${rewardPoints}, GETDATE())
                    `);
                }
            }

            await transaction.commit();
            
            res.send(`
                <h1 style="color:green; text-align:center;">ØªÙ… ØªÙØ¹ÙŠÙ„ Ø­Ø³Ø§Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­!</h1>
                <p style="text-align:center;">ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ø¹Ø¨Ø©.</p>
            `);

        } catch (err) {
            await transaction.rollback();
            throw err;
        }

    } catch (err) {
        console.error(err);
        res.status(500).send('<h1>Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªÙØ¹ÙŠÙ„</h1>');
    }
};

// ğŸ†• 4. Ø¯Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©: Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø§Ù„ØªÙØ¹ÙŠÙ„ (Resend Verification)
exports.resendVerification = async (req, res) => {
    const { username, password } = req.body; 

    try {
        const pool = await poolPromise;
        const userCheck = await pool.request()
            .input('uid', username)
            .query("SELECT UserNo, Email, Password, IsEmailVerified FROM AuthDB.dbo.T_Account WHERE UserId = @uid");

        const user = userCheck.recordset[0];
        if (!user) return res.status(404).json({ message: 'Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯' });
        if (user.Password !== password) return res.status(401).json({ message: 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø®Ø·Ø£' });
        if (user.IsEmailVerified) return res.status(400).json({ message: 'Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…ÙØ¹Ù„ Ø¨Ø§Ù„ÙØ¹Ù„!' });

        const newToken = uuidv4();
        await pool.request()
            .input('token', newToken)
            .input('uid', user.UserNo)
            .query("UPDATE AuthDB.dbo.T_Account SET VerificationToken = @token WHERE UserNo = @uid");

        const verifyLink = `http://localhost:3000/api/auth/verify-email?token=${newToken}`;
        
        await transporter.sendMail({
            from: `"Adrenaline Game" <${process.env.EMAIL_USER}>`,
            to: user.Email,
            subject: 'Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø§Ù„ØªÙØ¹ÙŠÙ„',
            html: `<h3>Ù…Ø±Ø­Ø¨Ø§Ù‹ ${username}</h3><p>Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨:</p><a href="${verifyLink}">ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¢Ù†</a>`
        });

        res.json({ status: 'success', message: `ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø§Ø¨Ø· Ù…Ø¬Ø¯Ø¯Ø§Ù‹ Ø¥Ù„Ù‰ ${user.Email}` });

    } catch (err) {
        res.status(500).json({ message: 'ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„' });
    }
};

// ğŸ†• 5. Ø¯Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©: ØªØµØ­ÙŠØ­ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ (Change Email & Resend)
exports.changePendingEmail = async (req, res) => {
    const { username, password, newEmail } = req.body;

    if (!newEmail) return res.status(400).json({ message: 'ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯' });

    try {
        const pool = await poolPromise;

        const userCheck = await pool.request()
            .input('uid', username)
            .query("SELECT UserNo, Password, IsEmailVerified FROM AuthDB.dbo.T_Account WHERE UserId = @uid");

        const user = userCheck.recordset[0];
        if (!user) return res.status(404).json({ message: 'Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯' });
        if (user.Password !== password) return res.status(401).json({ message: 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø®Ø·Ø£' });
        if (user.IsEmailVerified) return res.status(400).json({ message: 'Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØºÙŠÙŠØ± Ø§Ù„Ø¨Ø±ÙŠØ¯ØŒ Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…ÙØ¹Ù„ Ø¨Ø§Ù„ÙØ¹Ù„.' });

        // Ø§Ù„ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯ ØºÙŠØ± Ù…Ø³ØªØ®Ø¯Ù…
        const emailCheck = await pool.request()
            .input('email', newEmail)
            .query("SELECT UserNo FROM AuthDB.dbo.T_Account WHERE Email = @email");
        
        if (emailCheck.recordset.length > 0) return res.status(400).json({ message: 'Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø­Ø³Ø§Ø¨ Ø¢Ø®Ø±' });

        const newToken = uuidv4();
        await pool.request()
            .input('email', newEmail)
            .input('token', newToken)
            .input('uid', user.UserNo)
            .query("UPDATE AuthDB.dbo.T_Account SET Email = @email, VerificationToken = @token WHERE UserNo = @uid");

        const verifyLink = `http://localhost:3000/api/auth/verify-email?token=${newToken}`;
        
        await transporter.sendMail({
            from: `"Adrenaline Game" <${process.env.EMAIL_USER}>`,
            to: newEmail,
            subject: 'ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨ (Ø¨Ø±ÙŠØ¯ Ø¬Ø¯ÙŠØ¯)',
            html: `<h3>ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨Ø±ÙŠØ¯Ùƒ Ø¨Ù†Ø¬Ø§Ø­!</h3><p>Ø§Ø¶ØºØ· Ù‡Ù†Ø§ Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨:</p><a href="${verifyLink}">ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨</a>`
        });

        res.json({ status: 'success', message: `ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø¥Ù„Ù‰ ${newEmail} ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø§Ø¨Ø·.` });

    } catch (err) {
        res.status(500).json({ message: 'ÙØ´Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«' });
    }
};

// 6. Ø·Ù„Ø¨ Ø§Ø³ØªØ¹Ø§Ø¯Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (ÙƒÙ…Ø§ Ù‡Ùˆ ÙÙŠ Ù†Ø³Ø®ØªÙƒ)
// ... (Ø¨Ù‚ÙŠØ© Ø§Ù„ÙƒÙˆØ¯ ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰ ÙƒÙ…Ø§ Ù‡Ùˆ: login, register, verifyEmail, etc...)

// -------------------------------------------------------------------------
// Ù…Ù†Ø·Ù‚Ø© Ø§Ø³ØªØ¹Ø§Ø¯Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (Ø¨Ø¯ÙˆÙ† Ù…Ù„ÙØ§Øª HTML Ø®Ø§Ø±Ø¬ÙŠØ©)
// -------------------------------------------------------------------------

// 6. Ø·Ù„Ø¨ Ø§Ø³ØªØ¹Ø§Ø¯Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (Forgot Password)
exports.forgotPassword = async (req, res) => {
    const { email } = req.body;
    if (!email) return res.status(400).json({ message: 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ' });

    try {
        const pool = await poolPromise;
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„
        const userCheck = await pool.request().input('email', email).query("SELECT UserNo, UserId FROM AuthDB.dbo.T_Account WHERE Email = @email");

        if (userCheck.recordset.length === 0) return res.status(404).json({ message: 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± Ù…Ø³Ø¬Ù„' });

        const resetToken = uuidv4();
        const username = userCheck.recordset[0].UserId;

        // Ø­ÙØ¸ Ø§Ù„ØªÙˆÙƒÙ†
        await pool.request()
            .input('token', resetToken)
            .input('email', email)
            .query(`UPDATE AuthDB.dbo.T_Account SET PasswordResetToken = @token, ResetTokenExpiry = DATEADD(HOUR, 1, GETDATE()) WHERE Email = @email`);

        // ğŸ‘‡ Ø§Ù„ØªØºÙŠÙŠØ± Ù‡Ù†Ø§: Ø§Ù„Ø±Ø§Ø¨Ø· ÙŠØ´ÙŠØ± Ù„ØµÙØ­Ø© ØªÙˆÙ„Ø¯Ù‡Ø§ Ø§Ù„Ø³ÙŠØ±ÙØ± Ù…Ø¨Ø§Ø´Ø±Ø©
        const resetLink = `http://localhost:3000/api/auth/reset-password-page?token=${resetToken}`;

        // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„
        await transporter.sendMail({
            from: `"Adrenaline Support" <${process.env.EMAIL_USER}>`,
            to: email,
            subject: 'Ø§Ø³ØªØ¹Ø§Ø¯Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±',
            html: `
                <div style="font-family: Arial; text-align: center;">
                    <h3>ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</h3>
                    <p>Ù…Ø±Ø­Ø¨Ø§Ù‹ ${username}ØŒ Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ø¶ØºØ· Ù‡Ù†Ø§:</p>
                    <a href="${resetLink}" style="background-color: #333; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px;">ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</a>
                </div>
            `
        });

        res.json({ status: 'success', message: 'ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù„Ù„Ø¥ÙŠÙ…ÙŠÙ„.' });

    } catch (err) {
        console.error(err);
        res.status(500).json({ message: 'ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨' });
    }
};

// ğŸ†• 7. Ø¹Ø±Ø¶ ØµÙØ­Ø© ØªØºÙŠÙŠØ± Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯ (GET Request)
// Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© ØªØ±Ø³Ù… ØµÙØ­Ø© HTML Ù…Ø¨Ø§Ø´Ø±Ø© ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­ Ø¨Ø¯ÙˆÙ† Ù…Ù„Ù Ø®Ø§Ø±Ø¬ÙŠ
exports.getResetPasswordPage = (req, res) => {
    const { token } = req.query;

    if (!token) return res.send('<h1>Ø±Ø§Ø¨Ø· ØºÙŠØ± ØµØ§Ù„Ø­</h1>');

    // Ù†Ø±Ø³Ù„ ÙƒÙˆØ¯ HTML Ø¨Ø³ÙŠØ· ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ÙÙˆØ±Ù… ÙˆØ¥Ø³ÙƒØ±Ø¨Øª
    res.send(`
        <!DOCTYPE html>
        <html dir="rtl">
        <head>
            <meta charset="UTF-8">
            <title>ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</title>
            <style>
                body { font-family: Arial; background: #222; color: #fff; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
                .box { background: #333; padding: 30px; border-radius: 10px; text-align: center; width: 300px; box-shadow: 0 0 15px rgba(0,0,0,0.5); }
                input { width: 90%; padding: 10px; margin: 10px 0; border-radius: 5px; border: none; }
                button { width: 100%; padding: 10px; background: #e74c3c; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
                button:hover { background: #c0392b; }
            </style>
        </head>
        <body>
            <div class="box">
                <h2>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ğŸ”</h2>
                <input type="password" id="newPass" placeholder="Ø£ÙƒØªØ¨ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©">
                <button onclick="savePassword()">Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
                <p id="msg"></p>
            </div>

            <script>
                async function savePassword() {
                    const pass = document.getElementById('newPass').value;
                    const token = "${token}"; // Ø§Ù„Ø³ÙŠØ±ÙØ± ÙŠØ¶Ø¹ Ø§Ù„ØªÙˆÙƒÙ† Ù‡Ù†Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
                    
                    if(!pass) return alert('Ø£ÙƒØªØ¨ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±!');

                    const res = await fetch('/api/auth/reset-password', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ token: token, newPassword: pass })
                    });

                    const data = await res.json();
                    const msg = document.getElementById('msg');
                    
                    if(data.status === 'success') {
                        msg.style.color = 'lightgreen';
                        msg.innerText = 'ØªÙ… Ø§Ù„ØªØºÙŠÙŠØ± Ø¨Ù†Ø¬Ø§Ø­! ÙŠÙ…ÙƒÙ†Ùƒ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙØ­Ø©.';
                        document.getElementById('newPass').value = '';
                    } else {
                        msg.style.color = 'red';
                        msg.innerText = data.message;
                    }
                }
            </script>
        </body>
        </html>
    `);
};

// 8. ØªÙ†ÙÙŠØ° Ø§Ù„ØªØºÙŠÙŠØ± (POST Request) - (Ù†ÙØ³ Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©)
exports.resetPassword = async (req, res) => {
    const { token, newPassword } = req.body;
    // ... (Ù†ÙØ³ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø³Ø§Ø¨Ù‚ ØªÙ…Ø§Ù…Ø§Ù‹) ...
    if (!token || !newPassword) return res.status(400).json({ message: 'Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©' });

    try {
        const pool = await poolPromise;
        const result = await pool.request().input('token', token).query("SELECT UserNo FROM AuthDB.dbo.T_Account WHERE PasswordResetToken = @token AND ResetTokenExpiry > GETDATE()");

        if (result.recordset.length === 0) return res.status(400).json({ message: 'Ø§Ù„Ø±Ø§Ø¨Ø· Ù…Ù†ØªÙ‡ÙŠ Ø£Ùˆ ØºÙŠØ± ØµØ§Ù„Ø­' });

        await pool.request().input('pass', newPassword).input('uid', result.recordset[0].UserNo).query("UPDATE AuthDB.dbo.T_Account SET Password = @pass, PasswordResetToken = NULL, ResetTokenExpiry = NULL WHERE UserNo = @uid");

        res.json({ status: 'success', message: 'ØªÙ… ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­' });
    } catch (err) {
        res.status(500).json({ message: 'Ø®Ø·Ø£ Ø³ÙŠØ±ÙØ±' });
    }
};

// 7. ØªÙ†ÙÙŠØ° ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (ÙƒÙ…Ø§ Ù‡Ùˆ ÙÙŠ Ù†Ø³Ø®ØªÙƒ)
exports.resetPassword = async (req, res) => {
    const { token, newPassword } = req.body;
    if (!token || !newPassword) return res.status(400).json({ message: 'Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©' });

    try {
        const pool = await poolPromise;
        const result = await pool.request().input('token', token).query("SELECT UserNo FROM AuthDB.dbo.T_Account WHERE PasswordResetToken = @token AND ResetTokenExpiry > GETDATE()");

        if (result.recordset.length === 0) return res.status(400).json({ message: 'Ø§Ù„Ø±Ø§Ø¨Ø· Ù…Ù†ØªÙ‡ÙŠ Ø£Ùˆ ØºÙŠØ± ØµØ§Ù„Ø­' });

        await pool.request().input('pass', newPassword).input('uid', result.recordset[0].UserNo).query("UPDATE AuthDB.dbo.T_Account SET Password = @pass, PasswordResetToken = NULL, ResetTokenExpiry = NULL WHERE UserNo = @uid");

        res.json({ status: 'success', message: 'ØªÙ… ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­' });
    } catch (err) {
        console.error(err);
        res.status(500).json({ message: 'ÙØ´Ù„ ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±' });
    }
};
^^^^^^^^^^ FILE END: controllers\authController.js ^^^^^^^^^^

vvvvvvvvvv FILE START: controllers\couponAdminController.js vvvvvvvvvv
const { poolPromise, sql } = require('../config/db');

// Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªÙˆÙ„ÙŠØ¯ Ø­Ø±ÙˆÙ Ø¹Ø´ÙˆØ§Ø¦ÙŠØ©
const generateSegment = (length) => {
    const chars = '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ';
    let result = '';
    for (let i = 0; i < length; i++) {
        result += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return result;
};

// Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù‚ÙŠÙ…Ø© Ù„Ù€ SQL (Ø¥Ù…Ø§ Ø±Ù‚Ù… Ø£Ùˆ ÙƒÙ„Ù…Ø© NULL)
const fmtVal = (val) => val ? val : 'NULL';

// 1. Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø²Ù…Ø© Ù‚Ø³Ø§Ø¦Ù… Ù„Ù„Ø¨ÙŠØ¹ (Bundle)
exports.createBundle = async (req, res) => {
    const { name, desc, priceGP, publicFee, items } = req.body;

    try {
        const pool = await poolPromise;
        const request = pool.request()
            .input('name', name)
            .input('desc', desc)
            .input('price', priceGP)
            .input('fee', publicFee || 2000);

        // ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ù‚ÙŠÙ…: Ø¥Ø°Ø§ Ù„Ù… ÙŠÙˆØ¬Ø¯ Ø§Ù„Ø¹Ù†ØµØ± Ù†Ø³ØªØ®Ø¯Ù… 0 Ù„Ù„Ù…ØªØ¬Ø± (Ù„Ø§Ù† Web_CouponShop ÙŠÙØ¶Ù„ 0)
        // Ù„ÙƒÙ† Ø¥Ø°Ø§ Ø£Ø±Ø¯Øª NULL ÙÙŠ Ø§Ù„Ù…ØªØ¬Ø± Ø£ÙŠØ¶Ø§Ù‹ØŒ ØºÙŠØ± 0 Ø¥Ù„Ù‰ 'NULL'
        // Ù…Ù„Ø§Ø­Ø¸Ø©: Ø¹Ø§Ø¯Ø© Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„ÙˆÙŠØ¨ ØªÙ‚Ø¨Ù„ 0 ÙƒÙ‚ÙŠÙ…Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ©ØŒ Ù„ÙƒÙ† Ø³Ù†ØªØ±ÙƒÙ‡Ø§ 0 Ù‡Ù†Ø§ Ù„Ø¹Ø¯Ù… ØªØ¹Ù‚ÙŠØ¯ Ø§Ù„Ø¹Ø±Ø¶
        const safeItems = [];
        for (let i = 0; i < 9; i++) {
            safeItems[i] = items && items[i] ? items[i] : { id: 0, days: 0 };
        }

        await request.query(`
            INSERT INTO AdrenalineWeb.dbo.Web_CouponShop 
            (
                BundleName, Description, PriceGP, PublicFeeGP, 
                ItemId1, ItemDays1, ItemId2, ItemDays2, ItemId3, ItemDays3, 
                ItemId4, ItemDays4, ItemId5, ItemDays5, ItemId6, ItemDays6, 
                ItemId7, ItemDays7, ItemId8, ItemDays8, ItemId9, ItemDays9
            )
            VALUES 
            (
                @name, @desc, @price, @fee,
                ${safeItems[0].id}, ${safeItems[0].days}, ${safeItems[1].id}, ${safeItems[1].days}, ${safeItems[2].id}, ${safeItems[2].days},
                ${safeItems[3].id}, ${safeItems[3].days}, ${safeItems[4].id}, ${safeItems[4].days}, ${safeItems[5].id}, ${safeItems[5].days},
                ${safeItems[6].id}, ${safeItems[6].days}, ${safeItems[7].id}, ${safeItems[7].days}, ${safeItems[8].id}, ${safeItems[8].days}
            )
        `);

        res.json({ status: 'success', message: 'ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø²Ù…Ø© ÙÙŠ Ø§Ù„Ù…ØªØ¬Ø± Ø¨Ù†Ø¬Ø§Ø­' });
    } catch (err) {
        console.error(err);
        res.status(500).json({ message: 'ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø²Ù…Ø©', error: err.message });
    }
};

// 2. Ø¥Ù†Ø´Ø§Ø¡ "Ù‚Ø³ÙŠÙ…Ø© Ù‡Ø¯ÙŠØ©" (Promo Code) - Ù‡Ù†Ø§ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù‡Ù… Ù„Ù€ NULL
exports.createGiftCoupon = async (req, res) => {
    const { customCode, expireDays, maxUses, items, gameMoney } = req.body; 

    try {
        const pool = await poolPromise;
        
        // ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ÙƒÙˆØ¯
        let serialKey = customCode;
        if (!serialKey) {
            serialKey = `${generateSegment(6)}-${generateSegment(6)}-${generateSegment(4)}`;
        }
        serialKey = serialKey.toUpperCase();

        // ØªØ¬Ù‡ÙŠØ² Ù…ØµÙÙˆÙØ© Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø¨Ù‚ÙŠÙ… NULL Ø¥Ø°Ø§ ÙƒØ§Ù†Øª ÙØ§Ø±ØºØ©
        const dbItems = [];
        for (let i = 0; i < 9; i++) {
            if (items && items[i] && items[i].id > 0) {
                dbItems[i] = { id: items[i].id, days: items[i].days };
            } else {
                dbItems[i] = { id: 'NULL', days: 'NULL' }; // ğŸ‘ˆ Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù†Øµ 'NULL'
            }
        }

        const money = gameMoney || 0;

        // Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ ÙÙŠ GameDB Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„ØªÙŠ Ù‚Ø¯ ØªÙƒÙˆÙ† NULL
        await pool.request().query(`
            INSERT INTO GameDB.dbo.T_ItemSerialKey 
            (
                SerialKey, TargetUserNo, OneTimeKey, RegDate, ExpireDate, SupplyGameMoney,
                SupplyItemId1, SupplyItemDays1, SupplyItemId2, SupplyItemDays2, SupplyItemId3, SupplyItemDays3,
                SupplyItemId4, SupplyItemDays4, SupplyItemId5, SupplyItemDays5, SupplyItemId6, SupplyItemDays6,
                SupplyItemId7, SupplyItemDays7, SupplyItemId8, SupplyItemDays8, SupplyItemId9, SupplyItemDays9
            )
            VALUES 
            (
                '${serialKey}', NULL, 0, GETDATE(), DATEADD(DAY, ${expireDays || 365}, GETDATE()), ${money},
                ${dbItems[0].id}, ${dbItems[0].days}, ${dbItems[1].id}, ${dbItems[1].days}, ${dbItems[2].id}, ${dbItems[2].days},
                ${dbItems[3].id}, ${dbItems[3].days}, ${dbItems[4].id}, ${dbItems[4].days}, ${dbItems[5].id}, ${dbItems[5].days},
                ${dbItems[6].id}, ${dbItems[6].days}, ${dbItems[7].id}, ${dbItems[7].days}, ${dbItems[8].id}, ${dbItems[8].days}
            )
        `);

        res.json({ status: 'success', message: `ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ÙƒÙˆØ¯ Ø§Ù„Ù‡Ø¯ÙŠØ©: ${serialKey}`, code: serialKey });

    } catch (err) {
        console.error(err);
        res.status(500).json({ message: 'ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù‡Ø¯ÙŠØ©', error: err.message });
    }
};
^^^^^^^^^^ FILE END: controllers\couponAdminController.js ^^^^^^^^^^

vvvvvvvvvv FILE START: controllers\couponController.js vvvvvvvvvv
const { poolPromise, sql } = require('../config/db');
const { v4: uuidv4 } = require('uuid');
const { rewardPointsOnPurchase } = require('../utils/rewardSystem'); // ğŸ‘ˆ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¯Ø§Ù„Ø©

const generateSegment = (length) => {
    const chars = '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ';
    let result = '';
    for (let i = 0; i < length; i++) {
        result += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return result;
};

// Ø¯Ø§Ù„Ø© Ù„ØªØ­ÙˆÙŠÙ„ 0 Ø¥Ù„Ù‰ NULL (Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙÙŠ Ø§Ø³ØªØ¹Ù„Ø§Ù… SQL)
const toSqlVal = (val) => {
    // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù‚ÙŠÙ…Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© ÙˆØ£ÙƒØ¨Ø± Ù…Ù† 0 Ù†Ø±Ø¬Ø¹Ù‡Ø§ØŒ ÙˆØ¥Ù„Ø§ Ù†Ø±Ø¬Ø¹ Ø§Ù„Ù†Øµ 'NULL'
    return (val && val > 0) ? val : 'NULL';
};

// ... (GetShopBundles ØªØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡ÙŠ) ...
exports.getShopBundles = async (req, res) => {
    try {
        const pool = await poolPromise;
        const result = await pool.request().query(`
            SELECT BundleID, BundleName, Description, PriceGP, PublicFeeGP, 
                   ItemId1, ItemDays1, ItemId2, ItemDays2, ItemId3, ItemDays3
            FROM AdrenalineWeb.dbo.Web_CouponShop 
            WHERE IsActive = 1
        `);
        res.json({ status: 'success', bundles: result.recordset });
    } catch (err) {
        res.status(500).json({ message: 'Ø®Ø·Ø£', error: err.message });
    }
};

// 2. Ø´Ø±Ø§Ø¡ Ø­Ø²Ù…Ø© ÙˆØªÙˆÙ„ÙŠØ¯ Ø§Ù„ÙƒÙˆØ¯ (Ù…Ø¹ Ù…Ù†Ø·Ù‚ NULL)
exports.buyBundle = async (req, res) => {
    const { bundleId, makePublic } = req.body; 
    const userNo = req.user.userNo;

    try {
        const pool = await poolPromise;

        // Ø£. Ø¬Ù„Ø¨ Ø§Ù„Ø­Ø²Ù…Ø©
        const bundleRes = await pool.request().input('bid', bundleId).query("SELECT * FROM AdrenalineWeb.dbo.Web_CouponShop WHERE BundleID = @bid");
        const bundle = bundleRes.recordset[0];
        if (!bundle) return res.status(404).json({ message: 'Ø§Ù„Ø­Ø²Ù…Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©' });

        // Ø¨. Ø§Ù„Ø³Ø¹Ø± ÙˆØ§Ù„Ø±ØµÙŠØ¯
        let finalPrice = bundle.PriceGP;
        if (makePublic) finalPrice += bundle.PublicFeeGP;

        const userCheck = await pool.request().input('uid', userNo).query("SELECT CashMoney FROM GameDB.dbo.T_User WHERE UserNo = @uid");
        if (userCheck.recordset[0].CashMoney < finalPrice) {
            return res.status(400).json({ message: `Ø±ØµÙŠØ¯Ùƒ ØºÙŠØ± ÙƒØ§ÙÙ. Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: ${finalPrice} GP` });
        }

        // Ø¬. Ø§Ù„ØªÙ†ÙÙŠØ°
        const transaction = new sql.Transaction(pool);
        await transaction.begin();

        try {
            const request = new sql.Request(transaction);

            // 1. Ø®ØµÙ… Ø§Ù„Ù…Ø§Ù„
            await request.query(`UPDATE GameDB.dbo.T_User SET CashMoney = CashMoney - ${finalPrice} WHERE UserNo = ${userNo}`);

            // 2. ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ÙƒÙˆØ¯
            const newSerial = `${generateSegment(6)}-${generateSegment(6)}-${generateSegment(4)}`;
            const targetUserVal = makePublic ? 'NULL' : userNo;

            // 3. Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙƒÙˆØ¯ ÙÙŠ GameDB (Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¯Ø§Ù„Ø© toSqlVal Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø£ØµÙØ§Ø± Ø¥Ù„Ù‰ NULL) ğŸ› ï¸
            await request.query(`
                INSERT INTO GameDB.dbo.T_ItemSerialKey 
                (
                    SerialKey, TargetUserNo, OneTimeKey, RegDate, ExpireDate, SupplyGameMoney,
                    SupplyItemId1, SupplyItemDays1, SupplyItemId2, SupplyItemDays2, SupplyItemId3, SupplyItemDays3,
                    SupplyItemId4, SupplyItemDays4, SupplyItemId5, SupplyItemDays5, SupplyItemId6, SupplyItemDays6,
                    SupplyItemId7, SupplyItemDays7, SupplyItemId8, SupplyItemDays8, SupplyItemId9, SupplyItemDays9
                )
                VALUES 
                (
                    '${newSerial}', ${targetUserVal}, 1, GETDATE(), DATEADD(YEAR, 1, GETDATE()), ${bundle.GameMoney},
                    ${toSqlVal(bundle.ItemId1)}, ${toSqlVal(bundle.ItemDays1)}, 
                    ${toSqlVal(bundle.ItemId2)}, ${toSqlVal(bundle.ItemDays2)}, 
                    ${toSqlVal(bundle.ItemId3)}, ${toSqlVal(bundle.ItemDays3)},
                    ${toSqlVal(bundle.ItemId4)}, ${toSqlVal(bundle.ItemDays4)}, 
                    ${toSqlVal(bundle.ItemId5)}, ${toSqlVal(bundle.ItemDays5)}, 
                    ${toSqlVal(bundle.ItemId6)}, ${toSqlVal(bundle.ItemDays6)},
                    ${toSqlVal(bundle.ItemId7)}, ${toSqlVal(bundle.ItemDays7)}, 
                    ${toSqlVal(bundle.ItemId8)}, ${toSqlVal(bundle.ItemDays8)}, 
                    ${toSqlVal(bundle.ItemId9)}, ${toSqlVal(bundle.ItemDays9)}
                )
            `);

            // 4. ØªØ³Ø¬ÙŠÙ„ ÙÙŠ Ø§Ù„Ù…ÙˆÙ‚Ø¹
            await request.query(`
                INSERT INTO AdrenalineWeb.dbo.Web_UserCoupons (UserNo, SerialKey, BundleID, IsPublic)
                VALUES (${userNo}, '${newSerial}', ${bundleId}, ${makePublic ? 1 : 0})
            `);
            await rewardPointsOnPurchase(request, userNo, finalPrice);

            await transaction.commit();
            res.json({ status: 'success', message: 'ØªÙ… Ø´Ø±Ø§Ø¡ Ø§Ù„Ù‚Ø³ÙŠÙ…Ø© Ø¨Ù†Ø¬Ø§Ø­', serialKey: newSerial });

        } catch (err) {
            await transaction.rollback();
            throw err;
        }

    } catch (err) {
        console.error(err);
        res.status(500).json({ message: 'ÙØ´Ù„Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ©', error: err.message });
    }
};

// ... (Ø¨Ù‚ÙŠØ© Ø§Ù„Ø¯ÙˆØ§Ù„ getMyCoupons Ùˆ upgradeToPublic ØªØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡ÙŠ) ...
// 3. Ø¹Ø±Ø¶ Ù‚Ø³Ø§Ø¦Ù…ÙŠ ÙˆØ¥Ø¯Ø§Ø±ØªÙ‡Ø§
exports.getMyCoupons = async (req, res) => {
    const userNo = req.user.userNo;
    try {
        const pool = await poolPromise;
        const result = await pool.request().input('uid', userNo).query(`
            SELECT UC.RowID, UC.SerialKey, UC.IsPublic, UC.PurchaseDate, UC.Status,
                   B.BundleName, B.PublicFeeGP 
            FROM AdrenalineWeb.dbo.Web_UserCoupons UC
            JOIN AdrenalineWeb.dbo.Web_CouponShop B ON UC.BundleID = B.BundleID
            WHERE UC.UserNo = @uid
            ORDER BY UC.PurchaseDate DESC
        `);
        res.json({ status: 'success', coupons: result.recordset });
    } catch (err) {
        res.status(500).json({ message: 'Ø®Ø·Ø£' });
    }
};

// 4. ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù‚Ø³ÙŠÙ…Ø© Ù…Ù† "Ø®Ø§ØµØ©" Ø¥Ù„Ù‰ "Ø¹Ø§Ù…Ø©"
exports.upgradeToPublic = async (req, res) => {
    const { serialKey } = req.body;
    const userNo = req.user.userNo;

    try {
        const pool = await poolPromise;

        // Ø£. Ø¬Ù„Ø¨ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù‚Ø³ÙŠÙ…Ø©
        const couponRes = await pool.request()
            .input('uid', userNo)
            .input('key', serialKey)
            .query(`
                SELECT UC.IsPublic, UC.BundleID, B.PublicFeeGP 
                FROM AdrenalineWeb.dbo.Web_UserCoupons UC
                JOIN AdrenalineWeb.dbo.Web_CouponShop B ON UC.BundleID = B.BundleID
                WHERE UC.SerialKey = @key AND UC.UserNo = @uid
            `);
        
        const coupon = couponRes.recordset[0];
        if (!coupon) return res.status(404).json({ message: 'Ø§Ù„Ù‚Ø³ÙŠÙ…Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©' });
        if (coupon.IsPublic) return res.status(400).json({ message: 'Ø§Ù„Ù‚Ø³ÙŠÙ…Ø© Ø¹Ø§Ù…Ø© Ø¨Ø§Ù„ÙØ¹Ù„' });

        // Ø¨. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±ØµÙŠØ¯
        const fee = coupon.PublicFeeGP;
        const userCheck = await pool.request().input('uid', userNo).query("SELECT CashMoney FROM GameDB.dbo.T_User WHERE UserNo = @uid");
        if (userCheck.recordset[0].CashMoney < fee) {
            return res.status(400).json({ message: `Ù„Ø§ ØªÙ…Ù„Ùƒ Ø±ØµÙŠØ¯Ø§Ù‹ ÙƒØ§ÙÙŠØ§Ù‹ Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù‚Ø³ÙŠÙ…Ø©. Ø§Ù„Ø±Ø³ÙˆÙ…: ${fee} GP` });
        }

        // Ø¬. ØªÙ†ÙÙŠØ° Ø§Ù„ØªØ­Ø¯ÙŠØ«
        const transaction = new sql.Transaction(pool);
        await transaction.begin();
        try {
            const request = new sql.Request(transaction);

            // 1. Ø®ØµÙ… Ø§Ù„Ø±Ø³ÙˆÙ…
            await request.query(`UPDATE GameDB.dbo.T_User SET CashMoney = CashMoney - ${fee} WHERE UserNo = ${userNo}`);

            // 2. ØªØ­Ø¯ÙŠØ« Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù„Ø¹Ø¨Ø© (TargetUserNo = NULL)
            await request.query(`UPDATE GameDB.dbo.T_ItemSerialKey SET TargetUserNo = NULL WHERE SerialKey = '${serialKey}'`);

            // 3. ØªØ­Ø¯ÙŠØ« Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹
            await request.query(`UPDATE AdrenalineWeb.dbo.Web_UserCoupons SET IsPublic = 1 WHERE SerialKey = '${serialKey}'`);

            await transaction.commit();
            res.json({ status: 'success', message: 'ØªÙ… ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù‚Ø³ÙŠÙ…Ø© Ø¥Ù„Ù‰ Ø¹Ø§Ù…Ø© Ø¨Ù†Ø¬Ø§Ø­!' });

        } catch (err) {
            await transaction.rollback();
            throw err;
        }

    } catch (err) {
        res.status(500).json({ message: 'ÙØ´Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«' });
    }
};
^^^^^^^^^^ FILE END: controllers\couponController.js ^^^^^^^^^^

vvvvvvvvvv FILE START: controllers\inventoryController.js vvvvvvvvvv
const { poolPromise, sql } = require('../config/db');

// 1. Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø®Ø²Ù† (Ø§Ù„Ø¹Ù†Ø§ØµØ± ØºÙŠØ± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ÙÙ‚Ø·)
exports.getMyInventory = async (req, res) => {
    try {
        const pool = await poolPromise;
        const userNo = req.user.userNo;

        const result = await pool.request()
            .input('uid', userNo)
            .query(`
                SELECT 
                    UI.SerialNo,
                    UI.ItemId,
                    UI.Count,
                    UI.SealVal,
                    UI.Durability,
                    UI.Status, -- 1 = In Inventory, 2 = Equipped
                    UI.EndDate,
                    I.ItemName,
                    I.ItemType,
                    I.ImageURL,
                    
                    -- Ø­Ø³Ø§Ø¨ Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© Ù„Ù„Ø¹Ø±Ø¶
                    CASE 
                        WHEN UI.EndDate > GETDATE() THEN DATEDIFF(DAY, GETDATE(), UI.EndDate)
                        ELSE 0 
                    END AS DaysLeft,

                    -- ØªØ­Ø¯ÙŠØ¯ Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ù†ØªÙ‡ÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©
                    CASE 
                        WHEN UI.EndDate < GETDATE() THEN 1 
                        ELSE 0 
                    END AS IsExpired

                FROM GameDB.dbo.T_UserItem UI
                LEFT JOIN GameDB.dbo.T_ItemInfo I ON UI.ItemId = I.ItemId
                WHERE UI.UserNo = @uid 
                  AND UI.Status != 0      -- Ù„ÙŠØ³ Ù…Ø­Ø°ÙˆÙØ§Ù‹
                  AND UI.IsBaseItem = 0   -- ğŸ‘ˆ Ø´Ø±Ø· Ø£Ø³Ø§Ø³ÙŠ: Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
                ORDER BY UI.EndDate DESC
            `);

        res.json({
            status: 'success',
            inventory: result.recordset
        });

    } catch (err) {
        console.error('Inventory Error:', err);
        res.status(500).json({ message: 'Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø®Ø²Ù†', error: err.message });
    }
};

// 2. Ø®ØªÙ… Ø§Ù„Ø³Ù„Ø§Ø­ (Ù…Ø¹ Ø§Ù„Ø¯ÙØ¹ + Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø¥Ø¬Ø¨Ø§Ø±ÙŠ)
exports.sealItem = async (req, res) => {
    const { serialNo } = req.body;
    const userNo = req.user.userNo;

    try {
        const pool = await poolPromise;

        // Ø£. Ø¬Ù„Ø¨ ØªÙƒÙ„ÙØ© Ø§Ù„Ø®ØªÙ… Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹
        // Ù…Ù„Ø§Ø­Ø¸Ø©: ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…ÙØªØ§Ø­ 'SealCost' ÙÙŠ Ø¬Ø¯ÙˆÙ„ Web_SettingsØŒ Ø£Ùˆ Ø³ÙŠØ³ØªØ®Ø¯Ù… 1000 ÙƒÙ‚ÙŠÙ…Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
        const settingsResult = await pool.request()
            .query(`SELECT ConfigValue FROM AdrenalineWeb.dbo.Web_Settings WHERE ConfigKey = 'SealCost'`);
        
        const sealCost = settingsResult.recordset.length > 0 
            ? parseInt(settingsResult.recordset[0].ConfigValue) 
            : 1000; 

        // Ø¨. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø³Ù„Ø§Ø­ ÙˆØ±ØµÙŠØ¯ Ø§Ù„Ù„Ø§Ø¹Ø¨
        const checkResult = await pool.request()
            .input('serial', serialNo)
            .input('uid', userNo)
            .query(`
                SELECT 
                    UI.SealVal, 
                    UI.IsBaseItem, 
                    UI.Status,
                    U.CashMoney AS CurrentGP 
                FROM GameDB.dbo.T_UserItem UI
                JOIN GameDB.dbo.T_User U ON UI.UserNo = U.UserNo
                WHERE UI.SerialNo = @serial AND UI.UserNo = @uid
            `);

        const item = checkResult.recordset[0];

        // Ø§Ù„ØªØ­Ù‚Ù‚Ø§Øª Ø§Ù„Ù…Ù†Ø·Ù‚ÙŠØ©
        if (!item) return res.status(404).json({ message: 'Ø§Ù„Ø¹Ù†ØµØ± ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ø£Ùˆ Ù„Ø§ ØªÙ…Ù„ÙƒÙ‡' });
        if (item.IsBaseItem) return res.status(400).json({ message: 'Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø®ØªÙ… Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©' });
        if (item.SealVal !== 0) return res.status(400).json({ message: 'Ù‡Ø°Ø§ Ø§Ù„Ø³Ù„Ø§Ø­ Ù…Ø®ØªÙˆÙ… Ø¨Ø§Ù„ÙØ¹Ù„' });
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±ØµÙŠØ¯
        if (item.CurrentGP < sealCost) {
            return res.status(400).json({ message: `Ø±ØµÙŠØ¯Ùƒ ØºÙŠØ± ÙƒØ§ÙÙ. ØªÙƒÙ„ÙØ© Ø§Ù„Ø®ØªÙ…: ${sealCost} GP` });
        }

        // Ø¬. ØªÙ†ÙÙŠØ° Ø§Ù„Ø¹Ù…Ù„ÙŠØ© (Transaction) - Ù„Ø¶Ù…Ø§Ù† Ø³Ù„Ø§Ù…Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        const transaction = new sql.Transaction(pool);
        await transaction.begin();

        try {
            const request = new sql.Request(transaction);

            // 1. Ø®ØµÙ… ØªÙƒÙ„ÙØ© Ø§Ù„Ø®ØªÙ… Ù…Ù† Ø§Ù„Ù„Ø§Ø¹Ø¨
            await request.query(`
                UPDATE GameDB.dbo.T_User 
                SET CashMoney = CashMoney - ${sealCost} 
                WHERE UserNo = ${userNo}
            `);

            // 2. Ø®ØªÙ… Ø§Ù„Ø³Ù„Ø§Ø­ + Ø¥Ø¹Ø§Ø¯ØªÙ‡ Ù„Ù„Ù…Ø®Ø²Ù† (Status = 1) + ØªØµÙÙŠØ± Ø®Ø§Ù†Ø© Ø§Ù„Ø³Ù„Ø§Ø­ (WeaponSlotNo = 0)
            // Ù‡Ø°Ø§ ÙŠØ¶Ù…Ù† Ø£Ù†Ù‡ Ù„Ùˆ ÙƒØ§Ù† Ù…Ø¬Ù‡Ø²Ø§Ù‹ØŒ Ø³ÙŠØªØ­ÙˆÙ„ Ù„Ø­Ø§Ù„Ø© "ØºÙŠØ± Ù…Ø¬Ù‡Ø²" ÙÙŠ Ø®ØµØ§Ø¦Øµ Ø§Ù„Ø¹Ù†ØµØ± Ù†ÙØ³Ù‡
            await request.query(`
                UPDATE GameDB.dbo.T_UserItem 
                SET SealVal = 1, 
                    Status = 1, 
                    WeaponSlotNo = 0 
                WHERE SerialNo = ${serialNo}
            `);

            // 3. ğŸ‘ˆ Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ø­Ø§Ø³Ù…Ø©: Ø­Ø°ÙÙ‡ Ù…Ù† Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªØ¬Ù‡ÙŠØ²Ø§Øª (T_CharacterEquip)
            // Ù‡Ø°Ø§ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù‡Ùˆ Ø§Ù„Ø°ÙŠ ÙŠØ®Ø¨Ø± Ø§Ù„Ø³ÙŠØ±ÙØ± "Ù…Ø§Ø°Ø§ ÙŠØ±ØªØ¯ÙŠ Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø¢Ù†ØŸ"
            // Ø¥Ø°Ø§ Ù„Ù… Ù†Ø­Ø°Ù Ø§Ù„ØµÙ Ù…Ù† Ù‡Ù†Ø§ØŒ Ø³ÙŠØ¸Ù„ Ø§Ù„Ø³Ù„Ø§Ø­ ÙŠØ¸Ù‡Ø± ÙÙŠ ÙŠØ¯ Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù„Ø¹Ø¨Ø©
            await request.query(`
                DELETE FROM GameDB.dbo.T_CharacterEquip 
                WHERE ItemSerialNo = ${serialNo} AND UserNo = ${userNo}
            `);

            // Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
            await transaction.commit();

            res.json({ 
                status: 'success', 
                message: `ØªÙ… Ø®ØªÙ… Ø§Ù„Ø³Ù„Ø§Ø­ ÙˆØ¥Ù„ØºØ§Ø¡ ØªØ¬Ù‡ÙŠØ²Ù‡ Ø¨Ù†Ø¬Ø§Ø­. ØªÙ… Ø®ØµÙ… ${sealCost} GP.`,
                newBalance: item.CurrentGP - sealCost
            });

        } catch (err) {
            await transaction.rollback();
            throw err;
        }

    } catch (err) {
        console.error('Sealing Error:', err);
        res.status(500).json({ message: 'ÙØ´Ù„Øª Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø®ØªÙ…', error: err.message });
    }
};
^^^^^^^^^^ FILE END: controllers\inventoryController.js ^^^^^^^^^^

vvvvvvvvvv FILE START: controllers\loyaltyController.js vvvvvvvvvv
const { poolPromise, sql } = require('../config/db');
const { encodeReferralCode } = require('../utils/referralCodec'); // ğŸ‘ˆ Ø£Ø¶Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø± Ø¶Ø±ÙˆØ±ÙŠ Ø¬Ø¯Ø§Ù‹
// 1. Ø¹Ø±Ø¶ Ø¥Ø­ØµØ§Ø¦ÙŠØ§ØªÙŠ + Ø±Ø§Ø¨Ø· Ø§Ù„Ø¯Ø¹ÙˆØ© + Ø­Ø§Ù„Ø© Ø§Ù„Ù…ÙƒØ§ÙØ£Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ©
exports.getMyLoyaltyStats = async (req, res) => {
    const userNo = req.user.userNo;
    // ÙŠÙ…ÙƒÙ†Ùƒ ÙˆØ¶Ø¹ Ù‡Ø°Ø§ Ø§Ù„Ø±Ø§Ø¨Ø· ÙÙŠ Ù…Ù„Ù .env Ù„Ø§Ø­Ù‚Ø§Ù‹
    const SITE_URL = process.env.SITE_URL || 'http://localhost:3000'; 

    try {
        const pool = await poolPromise;
        
        // Ø¬Ù„Ø¨ Ø§Ù„Ù†Ù‚Ø§Ø· ÙˆØ¹Ø¯Ø¯ Ø§Ù„Ø¯Ø¹ÙˆØ§Øª
        const result = await pool.request()
            .input('uid', userNo)
            .query(`
                SELECT 
                    A.LoyaltyPoints,
                    (SELECT COUNT(*) FROM AuthDB.dbo.T_Account WHERE ReferredBy = A.UserNo AND IsEmailVerified = 1) AS InvitedCount
                FROM AuthDB.dbo.T_Account A
                WHERE A.UserNo = @uid
            `);

        const data = result.recordset[0];

        // Ø¬Ù„Ø¨ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ³Ø¬Ù„ Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„ÙŠÙˆÙ…ÙŠ
        const settings = await pool.request()
            .input('uid', userNo)
            .query(`
                SELECT ConfigKey, ConfigValue FROM AdrenalineWeb.dbo.Web_Settings 
                WHERE ConfigKey IN ('Loyalty_ExchangeRate_Cash', 'Loyalty_ExchangeRate_GP', 'ReferralMaxCount', 'DailyLoginPoints');

                SELECT LastClaimDate FROM AdrenalineWeb.dbo.Web_DailyAttendance WHERE UserNo = @uid;
            `);
        
        const rates = {};
        settings.recordsets[0].forEach(s => rates[s.ConfigKey] = s.ConfigValue);

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù‡Ù„ Ø§Ø³ØªÙ„Ù… Ø§Ù„Ù…ÙƒØ§ÙØ£Ø© Ø§Ù„ÙŠÙˆÙ…ØŸ
        let canClaimDaily = true;
        const dailyRecord = settings.recordsets[1][0];
        
        if (dailyRecord) {
            const lastDate = new Date(dailyRecord.LastClaimDate).toISOString().split('T')[0]; // YYYY-MM-DD
            const today = new Date().toISOString().split('T')[0];
            if (lastDate === today) canClaimDaily = false;
        }

        res.json({
            status: 'success',
            points: data.LoyaltyPoints,
            invitedCount: data.InvitedCount,
            maxInvites: parseInt(rates['ReferralMaxCount']) || 50,
            dailyRewardPoints: parseInt(rates['DailyLoginPoints']) || 5,
            
            // ğŸ‘ˆ Ø±Ø§Ø¨Ø· Ø§Ù„Ø¯Ø¹ÙˆØ© Ø§Ù„Ø¬Ø§Ù‡Ø²
            referralCode: encodeReferralCode(userNo), 
            referralLink: `${SITE_URL}/register?ref=${encodeReferralCode(userNo)}`,

            canClaimDaily: canClaimDaily, // true = Ø§Ù„Ø²Ø± Ù…ÙØ¹Ù„ØŒ false = Ø§Ù„Ø²Ø± Ù…Ø¹Ø·Ù„
            
            exchangeRates: {
                cash: parseInt(rates['Loyalty_ExchangeRate_Cash']) || 1,
                gp: parseInt(rates['Loyalty_ExchangeRate_GP']) || 1000
            }
        });

    } catch (err) {
        res.status(500).json({ message: 'Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', error: err.message });
    }
};

// 2. Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ù…ÙƒØ§ÙØ£Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ© (Daily Check-in)
exports.claimDailyReward = async (req, res) => {
    const userNo = req.user.userNo;

    try {
        const pool = await poolPromise;

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ (Server Side Validation)
        const check = await pool.request().input('uid', userNo).query(`SELECT LastClaimDate FROM AdrenalineWeb.dbo.Web_DailyAttendance WHERE UserNo = @uid`);
        
        if (check.recordset[0]) {
            const lastDate = new Date(check.recordset[0].LastClaimDate).toISOString().split('T')[0];
            const today = new Date().toISOString().split('T')[0];
            if (lastDate === today) return res.status(400).json({ message: 'Ù„Ù‚Ø¯ Ø§Ø³ØªÙ„Ù…Øª Ø§Ù„Ù…ÙƒØ§ÙØ£Ø© Ø§Ù„ÙŠÙˆÙ… Ø¨Ø§Ù„ÙØ¹Ù„' });
        }

        // Ø¬Ù„Ø¨ Ù‚ÙŠÙ…Ø© Ø§Ù„Ù†Ù‚Ø§Ø·
        const settingRes = await pool.request().query(`SELECT ConfigValue FROM AdrenalineWeb.dbo.Web_Settings WHERE ConfigKey = 'DailyLoginPoints'`);
        const points = settingRes.recordset[0] ? parseInt(settingRes.recordset[0].ConfigValue) : 5;

        // ØªÙ†ÙÙŠØ° Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
        const transaction = new sql.Transaction(pool);
        await transaction.begin();

        try {
            const request = new sql.Request(transaction);

            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù†Ù‚Ø§Ø·
            await request.query(`UPDATE AuthDB.dbo.T_Account SET LoyaltyPoints = LoyaltyPoints + ${points} WHERE UserNo = ${userNo}`);

            // ØªØ­Ø¯ÙŠØ« Ø³Ø¬Ù„ Ø§Ù„Ø­Ø¶ÙˆØ± (Insert or Update)
            await request.query(`
                IF EXISTS (SELECT * FROM AdrenalineWeb.dbo.Web_DailyAttendance WHERE UserNo = ${userNo})
                    UPDATE AdrenalineWeb.dbo.Web_DailyAttendance SET LastClaimDate = GETDATE(), Streak = Streak + 1 WHERE UserNo = ${userNo}
                ELSE
                    INSERT INTO AdrenalineWeb.dbo.Web_DailyAttendance (UserNo, LastClaimDate, Streak) VALUES (${userNo}, GETDATE(), 1)
            `);

            // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
            await request.query(`
                INSERT INTO AdrenalineWeb.dbo.Web_LoyaltyLog (UserNo, PointsSpent, RewardType, RewardAmount, Date)
                VALUES (${userNo}, 0, 'DAILY_LOGIN', ${points}, GETDATE())
            `);

            await transaction.commit();
            res.json({ status: 'success', message: `ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ±! Ø­ØµÙ„Øª Ø¹Ù„Ù‰ ${points} Ù†Ù‚Ø§Ø·`, pointsEarned: points });

        } catch (err) {
            await transaction.rollback();
            throw err;
        }

    } catch (err) {
        console.error(err);
        res.status(500).json({ message: 'ÙØ´Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©' });
    }
};

// 3. ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù†Ù‚Ø§Ø· (ÙƒÙ…Ø§ Ù‡ÙŠ Ø³Ø§Ø¨Ù‚Ø§Ù‹)
exports.exchangePoints = async (req, res) => {
    const { pointsToSpend, type } = req.body; 
    const userNo = req.user.userNo;

    if (!pointsToSpend || pointsToSpend <= 0) return res.status(400).json({ message: 'Ø§Ù„Ø¹Ø¯Ø¯ ØºÙŠØ± ØµØ­ÙŠØ­' });

    try {
        const pool = await poolPromise;
        const check = await pool.request().input('uid', userNo).query(`
            SELECT A.LoyaltyPoints, S.ConfigValue AS Rate
            FROM AuthDB.dbo.T_Account A, AdrenalineWeb.dbo.Web_Settings S
            WHERE A.UserNo = @uid AND S.ConfigKey = 'Loyalty_ExchangeRate_${type}'
        `);

        if (!check.recordset[0]) return res.status(400).json({ message: 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª' });
        
        const { LoyaltyPoints, Rate } = check.recordset[0];
        if (LoyaltyPoints < pointsToSpend) return res.status(400).json({ message: 'Ù†Ù‚Ø§Ø·Ùƒ ØºÙŠØ± ÙƒØ§ÙÙŠØ©' });

        const rewardAmount = pointsToSpend * parseInt(Rate);
        
        const transaction = new sql.Transaction(pool);
        await transaction.begin();
        try {
            const request = new sql.Request(transaction);
            await request.query(`UPDATE AuthDB.dbo.T_Account SET LoyaltyPoints = LoyaltyPoints - ${pointsToSpend} WHERE UserNo = ${userNo}`);
            
            const col = type === 'CASH' ? 'CashMoney' : 'GameMoney';
            await request.query(`UPDATE GameDB.dbo.T_User SET ${col} = ${col} + ${rewardAmount} WHERE UserNo = ${userNo}`);
            
            await request.query(`INSERT INTO AdrenalineWeb.dbo.Web_LoyaltyLog (UserNo, PointsSpent, RewardType, RewardAmount, Date) VALUES (${userNo}, ${pointsToSpend}, '${type}', ${rewardAmount}, GETDATE())`);
            
            await transaction.commit();
            res.json({ status: 'success', message: 'ØªÙ… Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­', newBalance: LoyaltyPoints - pointsToSpend });
        } catch (e) {
            await transaction.rollback();
            throw e;
        }
    } catch (err) {
        res.status(500).json({ message: 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ±' });
    }
};
^^^^^^^^^^ FILE END: controllers\loyaltyController.js ^^^^^^^^^^

vvvvvvvvvv FILE START: controllers\newsController.js vvvvvvvvvv
const { poolPromise } = require('../config/db');

// 1. Ø¹Ø±Ø¶ ÙƒÙ„ Ø§Ù„Ø£Ø®Ø¨Ø§Ø± (Ù…ØªØ§Ø­ Ù„Ù„Ø¬Ù…ÙŠØ¹)
exports.getAllNews = async (req, res) => {
    try {
        const pool = await poolPromise;
        // Ù†Ø¬Ù„Ø¨ Ø§Ù„Ø£Ø®Ø¨Ø§Ø± Ù…Ø±ØªØ¨Ø© Ù…Ù† Ø§Ù„Ø£Ø­Ø¯Ø« Ù„Ù„Ø£Ù‚Ø¯Ù…
        const result = await pool.request().query(`
            SELECT NewsID, Title, Content, Category, Author, CreateDate 
            FROM AdrenalineWeb.dbo.Web_News 
            ORDER BY CreateDate DESC
        `);

        res.json({ status: 'success', news: result.recordset });
    } catch (err) {
        res.status(500).json({ message: 'Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø£Ø®Ø¨Ø§Ø±', error: err.message });
    }
};

// 2. Ø¥Ø¶Ø§ÙØ© Ø®Ø¨Ø± Ø¬Ø¯ÙŠØ¯ (Ù„Ù„Ø£Ø¯Ù…Ù† ÙÙ‚Ø·)
exports.createNews = async (req, res) => {
    const { title, content, category } = req.body;
    // Ù†Ø³ØªØ®Ø¯Ù… Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ø§Ù„ØªÙˆÙƒÙ† ÙƒØ§Ø³Ù… Ù„Ù„ÙƒØ§ØªØ¨
    const author = req.user.userId || 'Admin'; 

    if (!title || !content) {
        return res.status(400).json({ message: 'Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙˆØ§Ù„Ù…Ø­ØªÙˆÙ‰ Ù…Ø·Ù„ÙˆØ¨Ø§Ù†' });
    }

    try {
        const pool = await poolPromise;
        
        await pool.request()
            .input('title', title)
            .input('content', content)
            .input('cat', category || 'General')
            .input('auth', author)
            .query(`
                INSERT INTO AdrenalineWeb.dbo.Web_News (Title, Content, Category, Author)
                VALUES (@title, @content, @cat, @auth)
            `);

        res.json({ status: 'success', message: 'ØªÙ… Ù†Ø´Ø± Ø§Ù„Ø®Ø¨Ø± Ø¨Ù†Ø¬Ø§Ø­' });
    } catch (err) {
        res.status(500).json({ message: 'ÙØ´Ù„ Ù†Ø´Ø± Ø§Ù„Ø®Ø¨Ø±', error: err.message });
    }
};

// 3. Ø­Ø°Ù Ø®Ø¨Ø± (Ù„Ù„Ø£Ø¯Ù…Ù† ÙÙ‚Ø·)
exports.deleteNews = async (req, res) => {
    const { id } = req.params; // Ù†Ø£Ø®Ø° Ø§Ù„Ø±Ù‚Ù… Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø· Ù…Ø¨Ø§Ø´Ø±Ø©

    try {
        const pool = await poolPromise;
        await pool.request()
            .input('id', id)
            .query('DELETE FROM AdrenalineWeb.dbo.Web_News WHERE NewsID = @id');

        res.json({ status: 'success', message: 'ØªÙ… Ø­Ø°Ù Ø§Ù„Ø®Ø¨Ø±' });
    } catch (err) {
        res.status(500).json({ message: 'ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ø®Ø¨Ø±', error: err.message });
    }
};
^^^^^^^^^^ FILE END: controllers\newsController.js ^^^^^^^^^^

vvvvvvvvvv FILE START: controllers\rankController.js vvvvvvvvvv
const { poolPromise } = require('../config/db');

// 1. ØªØ±ØªÙŠØ¨ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† (Top Players) - ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ GameDB
exports.getTopPlayers = async (req, res) => {
    try {
        const pool = await poolPromise;
        
        const result = await pool.request().query(`
            SELECT TOP 10
                U.Ranking,
                U.Nickname,
                U.Level,
                U.Exp,
                U.TotalKillCount,
                U.TotalDeathCount,
                -- Ø¬Ù„Ø¨ Ø§Ø³Ù… Ø§Ù„ÙƒÙ„Ø§Ù† Ø¥Ù† ÙˆØ¬Ø¯
                (SELECT C.ClanName FROM ClanDB.dbo.T_Clan C WHERE C.ClanNo = U.ClanNo) AS ClanName
            FROM GameDB.dbo.T_User U
            WHERE U.IsAccountBlock = 0 
              AND U.GMGrade = 0
            ORDER BY U.Exp DESC
        `);

        res.json({ status: 'success', list: result.recordset });
    } catch (err) {
        res.status(500).json({ message: 'Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ ØªØµÙ†ÙŠÙ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†', error: err.message });
    }
};

// 2. ØªØ±ØªÙŠØ¨ Ø§Ù„Ù‡Ø¯Ø§ÙÙŠÙ† (Top Killers) - ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ GameDB
exports.getTopKillers = async (req, res) => {
    try {
        const pool = await poolPromise;
        
        const result = await pool.request().query(`
            SELECT TOP 10
                U.Nickname,
                U.Level,
                U.TotalKillCount,
                U.TotalDeathCount,
                -- Ø­Ø³Ø§Ø¨ Ø§Ù„Ù€ KD Ratio
                CASE 
                    WHEN U.TotalDeathCount = 0 THEN U.TotalKillCount 
                    ELSE ROUND(CAST(U.TotalKillCount AS FLOAT) / U.TotalDeathCount, 2)
                END AS KDRatio,
                (SELECT C.ClanName FROM ClanDB.dbo.T_Clan C WHERE C.ClanNo = U.ClanNo) AS ClanName
            FROM GameDB.dbo.T_User U
            WHERE U.IsAccountBlock = 0 
              AND U.GMGrade = 0
            ORDER BY U.TotalKillCount DESC
        `);

        res.json({ status: 'success', list: result.recordset });
    } catch (err) {
        res.status(500).json({ message: 'Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù‡Ø¯Ø§ÙÙŠÙ†', error: err.message });
    }
};

// 3. ØªØ±ØªÙŠØ¨ Ø§Ù„ÙƒÙ„Ø§Ù†Ø§Øª (Top Clans) - ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ ClanDB Ø§Ù„Ø¬Ø¯ÙŠØ¯ ğŸ› ï¸
exports.getTopClans = async (req, res) => {
    try {
        const pool = await poolPromise;
        
        // Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª:
        // 1. Ø§Ø³ØªØ®Ø¯Ù…Ù†Ø§ C.CCBPoint Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† C.Point
        // 2. Ø¬Ù„Ø¨Ù†Ø§ Ø§Ø³Ù… Ø§Ù„Ù‚Ø§Ø¦Ø¯ Ù…Ù† Ø¬Ø¯ÙˆÙ„ Clan_MemberInfo
        // 3. Ø§Ø³ØªØ¨Ø¹Ø¯Ù†Ø§ Ø§Ù„ÙƒÙ„Ø§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ø°ÙˆÙØ© (Status != 2)
        const result = await pool.request().query(`
            SELECT TOP 10
                C.ClanName,
                C.VolumeLevel AS ClanLevel, -- Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ÙƒÙ„Ø§Ù†
                C.CCBPoint AS ClanPoints,   -- Ø§Ù„Ù†Ù‚Ø§Ø· (ØªÙ… Ø§Ù„ØªØµØ­ÙŠØ­)
                C.CCBWinCount,
                C.CCBLoseCount,
                -- Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡
                (SELECT COUNT(*) FROM ClanDB.dbo.T_ClanMember CM WHERE CM.ClanNo = C.ClanNo) AS MemberCount,
                -- Ø¬Ù„Ø¨ Ø§Ø³Ù… Ø§Ù„Ù‚Ø§Ø¦Ø¯
                (SELECT M.Nickname FROM ClanDB.dbo.Clan_MemberInfo M WHERE M.UserNo = C.MasterUserNo) AS MasterName
            FROM ClanDB.dbo.T_Clan C
            WHERE C.Status != 2 -- Ù„Ø§ Ù†Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„Ø§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ø°ÙˆÙØ©
            ORDER BY C.CCBPoint DESC
        `);

        res.json({ status: 'success', list: result.recordset });
    } catch (err) {
        res.status(500).json({ message: 'Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„ÙƒÙ„Ø§Ù†Ø§Øª', error: err.message });
    }
};
^^^^^^^^^^ FILE END: controllers\rankController.js ^^^^^^^^^^

vvvvvvvvvv FILE START: controllers\settingsController.js vvvvvvvvvv
const { poolPromise } = require('../config/db');

// 1. Ø¬Ù„Ø¨ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© (Ù…ØªØ§Ø­ Ù„Ù„Ø¬Ù…ÙŠØ¹ - Ù„Ù„Ø²ÙˆØ§Ø± ÙˆØ§Ù„Ù…ÙˆÙ‚Ø¹)
exports.getPublicSettings = async (req, res) => {
    try {
        const pool = await poolPromise;
        const result = await pool.request().query('SELECT ConfigKey, ConfigValue FROM AdrenalineWeb.dbo.Web_Settings');

        // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù…ØµÙÙˆÙØ© Ø¥Ù„Ù‰ ÙƒØ§Ø¦Ù† JSON Ø¨Ø³ÙŠØ·
        // Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø³ØªÙƒÙˆÙ† Ù…Ø«Ù„: { "ServerStatus": "Online", "DownloadLink": "..." }
        const settings = {};
        result.recordset.forEach(row => {
            settings[row.ConfigKey] = row.ConfigValue;
        });

        res.json({ status: 'success', settings: settings });

    } catch (err) {
        res.status(500).json({ message: 'Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª', error: err.message });
    }
};

// 2. ØªØ­Ø¯ÙŠØ« Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø¹ÙŠÙ† (Ù„Ù„Ø£Ø¯Ù…Ù† ÙÙ‚Ø·)
exports.updateSetting = async (req, res) => {
    const { key, value } = req.body;

    if (!key || value === undefined) {
        return res.status(400).json({ message: 'ÙŠØ¬Ø¨ Ø¥Ø±Ø³Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ ÙˆÙ‚ÙŠÙ…ØªÙ‡ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©' });
    }

    try {
        const pool = await poolPromise;
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù‡Ù„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ Ù…ÙˆØ¬ÙˆØ¯ Ø£ØµÙ„Ø§Ù‹ØŸ
        const check = await pool.request()
            .input('k', key)
            .query('SELECT ConfigKey FROM AdrenalineWeb.dbo.Web_Settings WHERE ConfigKey = @k');

        if (check.recordset.length === 0) {
            return res.status(404).json({ message: 'Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…' });
        }

        // Ø§Ù„ØªØ­Ø¯ÙŠØ«
        await pool.request()
            .input('val', value)
            .input('k', key)
            .query('UPDATE AdrenalineWeb.dbo.Web_Settings SET ConfigValue = @val WHERE ConfigKey = @k');

        res.json({ status: 'success', message: `ØªÙ… ØªØ­Ø¯ÙŠØ« ${key} Ø¨Ù†Ø¬Ø§Ø­` });

    } catch (err) {
        res.status(500).json({ message: 'ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª', error: err.message });
    }
};
^^^^^^^^^^ FILE END: controllers\settingsController.js ^^^^^^^^^^

vvvvvvvvvv FILE START: controllers\shopController.js vvvvvvvvvv
const { poolPromise, sql } = require('../config/db');

// 1. Ø¹Ø±Ø¶ Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…ØªØ¬Ø± (Ù„Ù… ÙŠØªØºÙŠØ±)
exports.getShopItems = async (req, res) => {
    try {
        const pool = await poolPromise;
        const result = await pool.request()
            .query(`
                SELECT ShopID, ItemName, PriceGP, Duration, Count, Category, ImageURL 
                FROM AdrenalineWeb.dbo.Web_Shop 
                WHERE IsActive = 1
            `);

        res.json({ status: 'success', items: result.recordset });
    } catch (err) {
        res.status(500).json({ message: 'Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù…ØªØ¬Ø±', error: err.message });
    }
};

// 2. Ø´Ø±Ø§Ø¡ Ø¹Ù†ØµØ± (Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ sp_BuyItem)
exports.buyItem = async (req, res) => {
    const { shopId } = req.body;
    const userNo = req.user.userNo;

    try {
        const pool = await poolPromise;

        // Ø£. Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ø£ÙˆÙ„Ù‰: Ø¯Ù…Ø¬ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…ØªØ¬Ø± (Ù„Ù„Ø³Ø¹Ø±) Ù…Ø¹ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø© (Ù„Ù„Ù…ÙˆØ§ØµÙØ§Øª Ø§Ù„ØªÙ‚Ù†ÙŠØ©)
        // Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù… "Ø§Ù„Ø°ÙƒÙŠ" ÙŠØ¬Ù„Ø¨ ÙƒÙ„ Ù…Ø§ Ù†Ø­ØªØ§Ø¬Ù‡ ÙÙŠ Ø¶Ø±Ø¨Ø© ÙˆØ§Ø­Ø¯Ø©
        const itemQuery = await pool.request()
            .input('sid', shopId)
            .query(`
                SELECT 
                    -- Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ù…ØªØ¬Ø± (Ø§Ù„Ø³Ø¹Ø± ÙˆØ§Ù„Ù…Ø¯Ø©)
                    W.PriceGP, 
                    W.Duration, 
                    W.ItemID, 
                    W.Count, 
                    W.ItemName,
                    
                    -- Ø¨ÙŠØ§Ù†Ø§Øª ØªÙ‚Ù†ÙŠØ© Ø­Ø³Ø§Ø³Ø© Ù…Ù† Ù…Ù„ÙØ§Øª Ø§Ù„Ù„Ø¹Ø¨Ø© (T_ItemInfo)
                    I.ItemType,
                    I.IsBaseItem,
                    I.IsGrenade,
                    I.NeedSlot,
                    I.RestrictLevel,
                    I.UseType,
                    I.IsPcBangItem
                FROM AdrenalineWeb.dbo.Web_Shop W
                JOIN GameDB.dbo.T_ItemInfo I ON W.ItemID = I.ItemId
                WHERE W.ShopID = @sid AND W.IsActive = 1
            `);

        const shopItem = itemQuery.recordset[0];

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¹Ù†ØµØ±
        if (!shopItem) {
            return res.status(404).json({ message: 'Ø§Ù„Ø¹Ù†ØµØ± ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ø£Ùˆ Ø®Ø·Ø£ ÙÙŠ ØªØ¹Ø±ÙŠÙ T_ItemInfo' });
        }

        // Ø¨. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø±ØµÙŠØ¯ Ø§Ù„Ù„Ø§Ø¹Ø¨
        const userCheck = await pool.request()
            .input('uid', userNo)
            .query('SELECT CashMoney FROM GameDB.dbo.T_User WHERE UserNo = @uid');
            
        const currentGP = userCheck.recordset[0].CashMoney;

        if (currentGP < shopItem.PriceGP) {
            return res.status(400).json({ 
                message: `Ø±ØµÙŠØ¯Ùƒ ØºÙŠØ± ÙƒØ§ÙÙ. ØªØ­ØªØ§Ø¬ ${shopItem.PriceGP} GP ÙˆØ£Ù†Øª ØªÙ…Ù„Ùƒ ${currentGP} GP` 
            });
        }

        // Ø¬. ØªÙ†ÙÙŠØ° Ø§Ù„Ø¹Ù…Ù„ÙŠØ© (Transaction)
        const transaction = new sql.Transaction(pool);
        await transaction.begin();

        try {
            const request = new sql.Request(transaction);

            // 1. Ø®ØµÙ… Ø§Ù„Ø±ØµÙŠØ¯
            await request.query(`
                UPDATE GameDB.dbo.T_User 
                SET CashMoney = CashMoney - ${shopItem.PriceGP} 
                WHERE UserNo = ${userNo}
            `);

            // 2. Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ù„Ø§Ø­ Ø¨Ø¯Ù‚Ø© Ø¹Ø§Ù„ÙŠØ© (Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù€ sp_BuyItem)
            // Ù†Ø³ØªØ®Ø¯Ù… ISNULL Ù„Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… Ø­Ø¯ÙˆØ« Ø®Ø·Ø£ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø¨Ø¹Ø¶ Ø§Ù„Ù‚ÙŠÙ… ÙØ§Ø±ØºØ© ÙÙŠ Ø§Ù„Ø¯Ø§ØªØ§Ø¨ÙŠØ²
            const insertQuery = `
                INSERT INTO GameDB.dbo.T_UserItem 
                (
                    UserNo, ItemId, ItemType, IsBaseItem, Count, Status, 
                    StartDate, EndDate, IsGrenade, NeedSlot, IsPcBangItem, 
                    RestrictLevel, UseType, SealVal
                )
                VALUES 
                (
                    ${userNo}, 
                    ${shopItem.ItemID}, 
                    ${shopItem.ItemType || 0},      -- ItemType Ù…Ù† Ø§Ù„Ù„Ø¹Ø¨Ø©
                    ${shopItem.IsBaseItem ? 1 : 0}, -- Ù‡Ù„ Ù‡Ùˆ Ø£Ø³Ø§Ø³ÙŠØŸ
                    ${shopItem.Count}, 
                    1,                              -- Status: 1 (Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ø­Ù‚ÙŠØ¨Ø© ØºÙŠØ± Ù…Ø¬Ù‡Ø²)
                    GETDATE(), 
                    DATEADD(DAY, ${shopItem.Duration}, GETDATE()), -- ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡
                    ${shopItem.IsGrenade ? 1 : 0},  -- Ù‡Ù„ Ù‡Ùˆ Ù‚Ù†Ø¨Ù„Ø©ØŸ
                    ${shopItem.NeedSlot || 0},      -- Ù‡Ù„ ÙŠØ­ØªØ§Ø¬ Ø®Ø§Ù†Ø©ØŸ
                    ${shopItem.IsPcBangItem ? 1 : 0}, 
                    ${shopItem.RestrictLevel || 0}, -- Ø§Ù„Ù„ÙÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨
                    ${shopItem.UseType || 0},       -- Ù†ÙˆØ¹ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…
                    0                               -- SealVal: 0 (Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙÙˆØ±Ø§Ù‹)
                )
            `;
            
            await request.query(insertQuery);

            await transaction.commit(); // Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©

            res.json({
                status: 'success',
                message: `ØªÙ… Ø´Ø±Ø§Ø¡ ${shopItem.ItemName} Ø¨Ù†Ø¬Ø§Ø­!`,
                newBalance: currentGP - shopItem.PriceGP
            });

        } catch (err) {
            await transaction.rollback(); // Ø¥Ù„ØºØ§Ø¡ ÙƒÙ„ Ø´ÙŠØ¡ ÙÙŠ Ø­Ø§Ù„ Ø§Ù„Ø®Ø·Ø£
            throw err;
        }

    } catch (err) {
        console.error('Shop Purchase Error:', err);
        res.status(500).json({ message: 'ÙØ´Ù„Øª Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø´Ø±Ø§Ø¡', error: err.message });
    }
};
^^^^^^^^^^ FILE END: controllers\shopController.js ^^^^^^^^^^

vvvvvvvvvv FILE START: controllers\userController.js vvvvvvvvvv
const { poolPromise, sql } = require('../config/db');

// 1. Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„
exports.getProfile = async (req, res) => {
    try {
        const pool = await poolPromise;
        const userNo = req.user.userNo; 

        const result = await pool.request()
            .input('id', userNo)
            .query(`
                SELECT 
                    U.Nickname,
                    U.Level,
                    U.Exp,
                    U.GameMoney AS Money,
                    U.CashMoney AS GP,
                    U.TotalWinCount,
                    U.TotalLoseCount,
                    U.TotalKillCount,
                    U.TotalDeathCount,
                    U.RegDate,
                    (SELECT TOP 1 C.ClanName FROM ClanDB.dbo.T_Clan C WHERE C.ClanNo = U.ClanNo) AS ClanName
                FROM GameDB.dbo.T_User U
                WHERE U.UserNo = @id
            `);

        if (result.recordset.length === 0) {
            return res.status(404).json({ message: 'Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù„Ø§Ø¹Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©' });
        }

        const playerData = result.recordset[0];

        const kdRatio = playerData.TotalDeathCount === 0 
            ? playerData.TotalKillCount 
            : (playerData.TotalKillCount / playerData.TotalDeathCount).toFixed(2);

        res.json({
            status: 'success',
            player: {
                ...playerData,
                kdRatio: kdRatio
            }
        });

    } catch (err) {
        console.error(err);
        res.status(500).json({ message: 'Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª' });
    }
};

// 2. ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
exports.changePassword = async (req, res) => {
    const { oldPassword, newPassword } = req.body;
    const userNo = req.user.userNo;

    if (!oldPassword || !newPassword) {
        return res.status(400).json({ message: 'ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© ÙˆØ§Ù„Ø¬Ø¯ÙŠØ¯Ø©' });
    }

    if (newPassword.length < 4) {
        return res.status(400).json({ message: 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù‚ØµÙŠØ±Ø© Ø¬Ø¯Ø§Ù‹' });
    }

    try {
        const pool = await poolPromise;

        const checkPass = await pool.request()
            .input('uid', userNo)
            .query('SELECT Password FROM AuthDB.dbo.T_Account WHERE UserNo = @uid');

        const currentAccount = checkPass.recordset[0];

        if (!currentAccount) {
            return res.status(404).json({ message: 'Ø§Ù„Ø­Ø³Ø§Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯' });
        }

        if (currentAccount.Password !== oldPassword) {
            return res.status(400).json({ message: 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© ØºÙŠØ± ØµØ­ÙŠØ­Ø©' });
        }

        await pool.request()
            .input('uid', userNo)
            .input('newPass', newPassword)
            .query('UPDATE AuthDB.dbo.T_Account SET Password = @newPass WHERE UserNo = @uid');

        res.json({ status: 'success', message: 'ØªÙ… ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­' });

    } catch (err) {
        console.error('Password Change Error:', err);
        res.status(500).json({ message: 'ÙØ´Ù„ ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±', error: err.message });
    }
};

// 3. Ø¹Ø±Ø¶ Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø¸Ø± (Ø¬Ø¯ÙŠØ¯)
exports.getBanStatus = async (req, res) => {
    const userNo = req.user.userNo;

    try {
        const pool = await poolPromise;
        
        const banInfo = await pool.request()
            .input('uid', userNo)
            .query(`
                SELECT TOP 1 Reason, BanDate, BannedBy 
                FROM AdrenalineWeb.dbo.Web_BanLog 
                WHERE UserNo = @uid AND IsActive = 1 
                ORDER BY BanID DESC
            `);

        const requestInfo = await pool.request()
            .input('uid', userNo)
            .query(`
                SELECT TOP 1 Status, FineAmount, RequestDate 
                FROM AdrenalineWeb.dbo.Web_UnbanRequests 
                WHERE UserNo = @uid 
                ORDER BY RequestID DESC
            `);

        res.json({
            status: 'success',
            isBanned: req.user.isBanned,
            banDetails: banInfo.recordset[0] || null,
            lastRequest: requestInfo.recordset[0] || null
        });

    } catch (err) {
        res.status(500).json({ message: 'Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª' });
    }
};

// 4. Ø·Ù„Ø¨ ÙÙƒ Ø§Ù„Ø­Ø¸Ø± (Ø¬Ø¯ÙŠØ¯)
exports.requestUnban = async (req, res) => {
    const userNo = req.user.userNo;
    const settingsRes = await pool.request()
    .query("SELECT ConfigValue FROM AdrenalineWeb.dbo.Web_Settings WHERE ConfigKey = 'UnbanFine'");

    try {
        const pool = await poolPromise;

        const checkPending = await pool.request()
            .input('uid', userNo)
            .query("SELECT * FROM AdrenalineWeb.dbo.Web_UnbanRequests WHERE UserNo = @uid AND Status = 'Pending'");

        if (checkPending.recordset.length > 0) {
            return res.status(400).json({ message: 'Ù„Ø¯ÙŠÙƒ Ø·Ù„Ø¨ Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø¨Ø§Ù„ÙØ¹Ù„ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±' });
        }

        await pool.request()
            .input('uid', userNo)
            .input('fine', fineAmount)
            .query(`
                INSERT INTO AdrenalineWeb.dbo.Web_UnbanRequests (UserNo, FineAmount, Status)
                VALUES (@uid, @fine, 'Pending')
            `);

        res.json({ status: 'success', message: 'ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ ÙÙƒ Ø§Ù„Ø­Ø¸Ø±. Ø³ÙŠÙ‚ÙˆÙ… Ø§Ù„Ø£Ø¯Ù…Ù† Ø¨Ù…Ø±Ø§Ø¬Ø¹ØªÙ‡ ÙˆØ®ØµÙ… Ø§Ù„ØºØ±Ø§Ù…Ø©.' });

    } catch (err) {
        res.status(500).json({ message: 'ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨', error: err.message });
    }
};
^^^^^^^^^^ FILE END: controllers\userController.js ^^^^^^^^^^

vvvvvvvvvv FILE START: middleware\adminMiddleware.js vvvvvvvvvv
module.exports = (req, res, next) => {
    // 1. Ù‡Ø°Ø§ Ø§Ù„Ù…ÙŠØ¯Ù„ÙˆÙŠØ± ÙŠØ¹Ù…Ù„ Ø¨Ø¹Ø¯ authMiddlewareØŒ Ù„Ø°Ø§ Ù†ÙØªØ±Ø¶ ÙˆØ¬ÙˆØ¯ req.user
    // 2. Ù†ØªØ­Ù‚Ù‚ Ù‡Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ø¯Ù…Ù†ØŸ (isAdmin Ø§Ù„ØªÙŠ ÙˆØ¶Ø¹Ù†Ø§Ù‡Ø§ ÙÙŠ Ø§Ù„ØªÙˆÙƒÙ† Ø¹Ù†Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„)
    
    if (!req.user || !req.user.isAdmin) {
        return res.status(403).json({ message: 'ØºÙŠØ± Ù…ØµØ±Ø­ Ù„Ùƒ (Ù‡Ø°Ù‡ Ø§Ù„Ù…ÙŠØ²Ø© Ù„Ù„Ù…Ø´Ø±ÙÙŠÙ† ÙÙ‚Ø·)' });
    }

    next(); // Ø§Ø³Ù…Ø­ Ù„Ù‡ Ø¨Ø§Ù„Ù…Ø±ÙˆØ±
};
^^^^^^^^^^ FILE END: middleware\adminMiddleware.js ^^^^^^^^^^

vvvvvvvvvv FILE START: middleware\authMiddleware.js vvvvvvvvvv
const jwt = require('jsonwebtoken');
const JWT_SECRET = process.env.JWT_SECRET || 'super_secret_adrenaline_key_2026';

module.exports = (req, res, next) => {
    // 1. Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ØªÙˆÙƒÙ† ÙÙŠ "ØªØ±ÙˆÙŠØ³Ø©" Ø§Ù„Ø·Ù„Ø¨ (Header)
    const token = req.header('x-auth-token');

    // 2. Ø¥Ø°Ø§ Ù„Ù… ÙŠØ±Ø³Ù„ Ø§Ù„ØªÙˆÙƒÙ†ØŒ Ù†Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨
    if (!token) {
        return res.status(401).json({ message: 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¥Ø°Ù† Ø¯Ø®ÙˆÙ„ØŒ Ø§Ù„ØªÙˆÙƒÙ† Ù…ÙÙ‚ÙˆØ¯' });
    }

    try {
        // 3. ÙÙƒ ØªØ´ÙÙŠØ± Ø§Ù„ØªÙˆÙƒÙ† Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØµØ­ØªÙ‡
        const decoded = jwt.verify(token, JWT_SECRET);
        
        // 4. Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø§Ù„Ø·Ù„Ø¨ Ù„Ù†Ø³ØªØ®Ø¯Ù…Ù‡Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹
        req.user = decoded;
        
        next(); // Ø§Ø³Ù…Ø­ Ù„Ù‡ Ø¨Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ù„ÙƒÙˆØ¯ Ø§Ù„ØªØ§Ù„ÙŠ
    } catch (err) {
        res.status(401).json({ message: 'Ø§Ù„ØªÙˆÙƒÙ† ØºÙŠØ± ØµØ§Ù„Ø­ Ø£Ùˆ Ù…Ù†ØªÙ‡ÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©' });
    }
};
^^^^^^^^^^ FILE END: middleware\authMiddleware.js ^^^^^^^^^^

vvvvvvvvvv FILE START: package.json vvvvvvvvvv
{
  "name": "ad-sile",
  "version": "1.0.0",
  "description": "",
  "main": "index.js",
  "scripts": {
    "start": "node server.js",
    "dev": "nodemon server.js"
  },
  "keywords": [],
  "author": "",
  "license": "ISC",
  "type": "commonjs",
  "dependencies": {
    "bcryptjs": "^3.0.3",
    "cors": "^2.8.6",
    "dotenv": "^17.2.3",
    "express": "^5.2.1",
    "jsonwebtoken": "^9.0.3",
    "morgan": "^1.10.1",
    "mssql": "^12.2.0",
    "nodemailer": "^7.0.12",
    "uuid": "^13.0.0"
  },
  "devDependencies": {
    "nodemon": "^3.1.11"
  }
}

^^^^^^^^^^ FILE END: package.json ^^^^^^^^^^

vvvvvvvvvv FILE START: routes\adminRoutes.js vvvvvvvvvv
const express = require('express');
const router = express.Router();
const adminController = require('../controllers/adminController');
const auth = require('../middleware/authMiddleware');
const admin = require('../middleware/adminMiddleware');

// Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±ÙˆØ§Ø¨Ø· ØªØªØ·Ù„Ø¨: ØªÙˆÙƒÙ† + ØµÙ„Ø§Ø­ÙŠØ© Ø£Ø¯Ù…Ù†
router.post('/ban', auth, admin, adminController.banPlayer);
router.get('/unban-requests', auth, admin, adminController.getUnbanRequests);
router.post('/approve-unban', auth, admin, adminController.approveUnban);

module.exports = router;
^^^^^^^^^^ FILE END: routes\adminRoutes.js ^^^^^^^^^^

vvvvvvvvvv FILE START: routes\authRoutes.js vvvvvvvvvv
const express = require('express');
const router = express.Router();
const authController = require('../controllers/authController');

// 1. ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
router.post('/login', authController.login);

// 2. ØªØ³Ø¬ÙŠÙ„ Ø¬Ø¯ÙŠØ¯ (ÙŠÙ†Ø´Ø¦ Ø­Ø³Ø§Ø¨ ÙÙ‚Ø·)
router.post('/register', authController.register);

// 3. ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ (Ø±Ø§Ø¨Ø· GET ÙŠÙØªØ­ ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­)
router.get('/verify-email', authController.verifyEmail);
// ... Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© (login, register, verify-email)

// 4. Ø·Ù„Ø¨ Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© (ÙŠØ±Ø³Ù„ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„)
router.post('/forgot-password', authController.forgotPassword);

// 5. ØªÙ†ÙÙŠØ° Ø§Ù„ØªØºÙŠÙŠØ± (ÙŠØ³ØªÙ‚Ø¨Ù„ Ø§Ù„ØªÙˆÙƒÙ† ÙˆØ§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯)
router.post('/reset-password', authController.resetPassword);
router.post('/resend-verification', authController.resendVerification); // Ø²Ø± "Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„"
router.post('/change-pending-email', authController.changePendingEmail); // Ø²Ø± "ØªØµØ­ÙŠØ­ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„"
router.post('/forgot-password', authController.forgotPassword);

// 2. Ø§Ù„ØµÙØ­Ø© Ø§Ù„ØªÙŠ ØªØ¸Ù‡Ø± Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø§Ø¨Ø· ÙÙŠ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ (GET) ğŸ†•
router.get('/reset-password-page', authController.getResetPasswordPage);

// 3. Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯ (POST)
router.post('/reset-password', authController.resetPassword);

module.exports = router;
^^^^^^^^^^ FILE END: routes\authRoutes.js ^^^^^^^^^^

vvvvvvvvvv FILE START: routes\couponAdminRoutes.js vvvvvvvvvv
const express = require('express');
const router = express.Router();
const couponAdminController = require('../controllers/couponAdminController');
const auth = require('../middleware/authMiddleware');
const admin = require('../middleware/adminMiddleware');

// Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±ÙˆØ§Ø¨Ø· ØªØªØ·Ù„Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø£Ø¯Ù…Ù†
router.post('/create-bundle', auth, admin, couponAdminController.createBundle);
router.post('/create-gift', auth, admin, couponAdminController.createGiftCoupon);

module.exports = router;
^^^^^^^^^^ FILE END: routes\couponAdminRoutes.js ^^^^^^^^^^

vvvvvvvvvv FILE START: routes\couponRoutes.js vvvvvvvvvv
const express = require('express');
const router = express.Router();
const couponController = require('../controllers/couponController');
const auth = require('../middleware/authMiddleware');

// 1. Ø¹Ø±Ø¶ Ù…ØªØ¬Ø± Ø§Ù„Ø­Ø²Ù… (Ù…ØªØ§Ø­ Ù„Ù„Ù…Ø³Ø¬Ù„ÙŠÙ†)
router.get('/shop', auth, couponController.getShopBundles);

// 2. Ø´Ø±Ø§Ø¡ Ø­Ø²Ù…Ø© (ØªÙˆÙ„ÙŠØ¯ ÙƒÙˆØ¯)
router.post('/buy', auth, couponController.buyBundle);

// 3. Ø¹Ø±Ø¶ Ù‚Ø³Ø§Ø¦Ù…ÙŠ
router.get('/my-coupons', auth, couponController.getMyCoupons);

// 4. ØªØ±Ù‚ÙŠØ© Ø§Ù„Ù‚Ø³ÙŠÙ…Ø© Ù„Ø¹Ø§Ù…Ø©
router.post('/upgrade', auth, couponController.upgradeToPublic);

module.exports = router;
^^^^^^^^^^ FILE END: routes\couponRoutes.js ^^^^^^^^^^

vvvvvvvvvv FILE START: routes\inventoryRoutes.js vvvvvvvvvv
const express = require('express');
const router = express.Router();
const inventoryController = require('../controllers/inventoryController');
const auth = require('../middleware/authMiddleware');

router.get('/my-items', auth, inventoryController.getMyInventory);
router.post('/seal', auth, inventoryController.sealItem);
// ØªÙ… Ø­Ø°Ù unseal Ø­Ø³Ø¨ Ø·Ù„Ø¨Ùƒ

module.exports = router;
^^^^^^^^^^ FILE END: routes\inventoryRoutes.js ^^^^^^^^^^

vvvvvvvvvv FILE START: routes\loyaltyRoutes.js vvvvvvvvvv
const express = require('express');
const router = express.Router();
const loyaltyController = require('../controllers/loyaltyController');
const auth = require('../middleware/authMiddleware');

router.get('/my-stats', auth, loyaltyController.getMyLoyaltyStats);
router.post('/exchange', auth, loyaltyController.exchangePoints);
router.post('/daily-claim', auth, loyaltyController.claimDailyReward); // ğŸ‘ˆ Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø¬Ø¯ÙŠØ¯

module.exports = router;
^^^^^^^^^^ FILE END: routes\loyaltyRoutes.js ^^^^^^^^^^

vvvvvvvvvv FILE START: routes\newsRoutes.js vvvvvvvvvv
const express = require('express');
const router = express.Router();
const newsController = require('../controllers/newsController');
const auth = require('../middleware/authMiddleware');
const admin = require('../middleware/adminMiddleware'); // Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ø£Ø¯Ù…Ù†

// 1. Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø®Ø¨Ø§Ø± (Ù…ØªØ§Ø­ Ù„Ù„Ø¬Ù…ÙŠØ¹ - Ù„Ø§ ÙŠØ­ØªØ§Ø¬ ØªÙˆÙƒÙ†)
router.get('/list', newsController.getAllNews);

// 2. Ø¥Ø¶Ø§ÙØ© Ø®Ø¨Ø± (ÙŠØ­ØªØ§Ø¬ ØªÙˆÙƒÙ† + ØµÙ„Ø§Ø­ÙŠØ© Ø£Ø¯Ù…Ù†)
// Ø§Ù„ØªØ±ØªÙŠØ¨ Ù…Ù‡Ù…: ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙˆÙƒÙ† Ø£ÙˆÙ„Ø§Ù‹ (auth)ØŒ Ø«Ù… ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© (admin)
router.post('/add', auth, admin, newsController.createNews);

// 3. Ø­Ø°Ù Ø®Ø¨Ø± (ÙŠØ­ØªØ§Ø¬ ØªÙˆÙƒÙ† + ØµÙ„Ø§Ø­ÙŠØ© Ø£Ø¯Ù…Ù†)
router.delete('/delete/:id', auth, admin, newsController.deleteNews);

module.exports = router;
^^^^^^^^^^ FILE END: routes\newsRoutes.js ^^^^^^^^^^

vvvvvvvvvv FILE START: routes\rankRoutes.js vvvvvvvvvv
const express = require('express');
const router = express.Router();
const rankController = require('../controllers/rankController');

// Ù‡Ø°Ù‡ Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ø¹Ø§Ù…Ø© (Ù„Ø§ ØªØ­ØªØ§Ø¬ ØªÙˆÙƒÙ† auth) Ù„Ø£Ù† Ø£ÙŠ Ø´Ø®Øµ Ø²Ø§Ø¦Ø± ÙŠÙ…ÙƒÙ†Ù‡ Ø±Ø¤ÙŠØ© Ø§Ù„ØªØ±ØªÙŠØ¨
router.get('/players', rankController.getTopPlayers);
router.get('/killers', rankController.getTopKillers);
router.get('/clans', rankController.getTopClans);

module.exports = router;
^^^^^^^^^^ FILE END: routes\rankRoutes.js ^^^^^^^^^^

vvvvvvvvvv FILE START: routes\settingsRoutes.js vvvvvvvvvv
const express = require('express');
const router = express.Router();
const settingsController = require('../controllers/settingsController');
const auth = require('../middleware/authMiddleware');
const admin = require('../middleware/adminMiddleware');

// 1. Ø¬Ù„Ø¨ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª (Ù…ÙØªÙˆØ­ Ù„Ù„Ø¬Ù…ÙŠØ¹ - Ù„Ø§ ÙŠØ­ØªØ§Ø¬ ØªÙˆÙƒÙ†)
// Ù„Ø£Ù† Ø§Ù„Ø²Ø§Ø¦Ø± ÙŠØ­ØªØ§Ø¬ Ù…Ø¹Ø±ÙØ© Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù‚Ø¨Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
router.get('/public', settingsController.getPublicSettings);

// 2. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª (Ù„Ù„Ø£Ø¯Ù…Ù† ÙÙ‚Ø·)
router.post('/update', auth, admin, settingsController.updateSetting);

module.exports = router;
^^^^^^^^^^ FILE END: routes\settingsRoutes.js ^^^^^^^^^^

vvvvvvvvvv FILE START: routes\shopRoutes.js vvvvvvvvvv
const express = require('express');
const router = express.Router();
const shopController = require('../controllers/shopController');
const auth = require('../middleware/authMiddleware');

// Ø¹Ø±Ø¶ Ø§Ù„Ù…ØªØ¬Ø± (Ù…ØªØ§Ø­ Ù„Ù„Ø¬Ù…ÙŠØ¹ Ø£Ùˆ Ù„Ù„Ø£Ø¹Ø¶Ø§Ø¡ ÙÙ‚Ø·ØŒ Ù‡Ù†Ø§ Ø¬Ø¹Ù„ØªÙ‡ Ù„Ù„Ø£Ø¹Ø¶Ø§Ø¡)
router.get('/list', auth, shopController.getShopItems);

// Ø§Ù„Ø´Ø±Ø§Ø¡ (ÙŠØªØ·Ù„Ø¨ ØªÙˆÙƒÙ†)
router.post('/buy', auth, shopController.buyItem);

module.exports = router;
^^^^^^^^^^ FILE END: routes\shopRoutes.js ^^^^^^^^^^

vvvvvvvvvv FILE START: routes\userRoutes.js vvvvvvvvvv
const express = require('express');
const router = express.Router();
const userController = require('../controllers/userController');
const auth = require('../middleware/authMiddleware');

// Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
router.get('/profile', auth, userController.getProfile);
router.post('/change-password', auth, userController.changePassword);

// Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ø­Ø¸Ø± (ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ Ù†Ø³Ø®Øª Ø§Ù„ÙƒÙˆØ¯ Ø£Ø¹Ù„Ø§Ù‡ Ù„ÙƒÙŠ ØªØ¹Ù…Ù„ Ù‡Ø°Ù‡ Ø§Ù„Ø¯ÙˆØ§Ù„)
router.get('/ban-info', auth, userController.getBanStatus);
router.post('/request-unban', auth, userController.requestUnban);

module.exports = router;
^^^^^^^^^^ FILE END: routes\userRoutes.js ^^^^^^^^^^

vvvvvvvvvv FILE START: server.js vvvvvvvvvv
const express = require('express');
const cors = require('cors');
const morgan = require('morgan');
require('dotenv').config();
const { poolPromise } = require('./config/db'); // Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù„Ù Ø§Ù„Ø§ØªØµØ§Ù„
const authRoutes = require('./routes/authRoutes');
const userRoutes = require('./routes/userRoutes'); // ğŸ‘ˆ Ø£Ø¶Ù Ù‡Ø°Ø§
const inventoryRoutes = require('./routes/inventoryRoutes');
const shopRoutes = require('./routes/shopRoutes'); // ğŸ‘ˆ 1. Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…Ù„Ù
const rankRoutes = require('./routes/rankRoutes'); // ğŸ‘ˆ
const newsRoutes = require('./routes/newsRoutes'); // ğŸ‘ˆ
const adminRoutes = require('./routes/adminRoutes'); // ğŸ‘ˆ 1. Ø£Ø¶Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø±
const settingsRoutes = require('./routes/settingsRoutes'); // ğŸ‘ˆ
const couponRoutes = require('./routes/couponRoutes');
const couponAdminRoutes = require('./routes/couponAdminRoutes');
const loyaltyRoutes = require('./routes/loyaltyRoutes');
const app = express();

// Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© (Middleware)
app.use(cors()); // Ù„Ù„Ø³Ù…Ø§Ø­ Ù„Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù€ API
app.use(express.json()); // Ù„ÙÙ‡Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨ØµÙŠØºØ© JSON
app.use(morgan('dev')); // Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª ÙÙŠ Ø§Ù„ØªÙŠØ±Ù…ÙŠÙ†Ø§Ù„
app.use('/api/auth', authRoutes);
app.use('/api/user', userRoutes); // ğŸ‘ˆ Ø£Ø¶Ù Ù‡Ø°Ø§
app.use('/api/inventory', inventoryRoutes);
app.use('/api/shop', shopRoutes); // ğŸ‘ˆ 2. ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø±Ø§Ø¨Ø·
app.use('/api/rank', rankRoutes); // ğŸ‘ˆ
app.use('/api/news', newsRoutes); // ğŸ‘ˆ
app.use('/api/admin', adminRoutes); // ğŸ‘ˆ 2. Ø£Ø¶Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø± Ø¶Ø±ÙˆØ±ÙŠ Ø¬Ø¯Ø§Ù‹
app.use('/api/settings', settingsRoutes); // ğŸ‘ˆ
app.use('/api/coupon', couponRoutes);           // Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†
app.use('/api/admin/coupon', couponAdminRoutes); // Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ø£Ø¯Ù…Ù†
app.use('/api/loyalty', loyaltyRoutes);
// === Ø±Ø§Ø¨Ø· ØªØ¬Ø±ÙŠØ¨ÙŠ (Test Route) ===
// Ù‡Ø°Ø§ Ø§Ù„Ø±Ø§Ø¨Ø· Ø³ÙŠÙØ­Øµ Ø§Ù„Ø§ØªØµØ§Ù„ ÙˆÙŠØ¬Ù„Ø¨ Ø§Ù„Ø£Ø®Ø¨Ø§Ø± Ù…Ù† Ø¬Ø¯ÙˆÙ„ Web_News
app.get('/', async (req, res) => {
    try {
        // 1. Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø§ØªØµØ§Ù„
        const pool = await poolPromise;
        
        // 2. ØªÙ†ÙÙŠØ° Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø¨Ø³ÙŠØ·
        const result = await pool.request().query('SELECT * FROM Web_News');
        
        // 3. Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†ØªÙŠØ¬Ø©
        res.json({
            status: 'success',
            message: 'API is Online & Connected to SQL!',
            news_data: result.recordset
        });
    } catch (err) {
        // ÙÙŠ Ø­Ø§Ù„ ÙˆØ¬ÙˆØ¯ Ø®Ø·Ø£
        res.status(500).json({ error: err.message });
    }
});

// ØªØ´ØºÙŠÙ„ Ø§Ù„Ø³ÙŠØ±ÙØ±
const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
    console.log(`ğŸš€ Server running on http://localhost:${PORT}`);
});
^^^^^^^^^^ FILE END: server.js ^^^^^^^^^^

vvvvvvvvvv FILE START: utils\referralCodec.js vvvvvvvvvv
// Ø¥Ø²Ø§Ø­Ø© Ø§Ù„Ø±Ù‚Ù… Ù„ÙƒÙŠ Ù„Ø§ ÙŠØ¨Ø¯Ùˆ ÙƒÙˆØ¯ Ø£ÙˆÙ„ Ù„Ø§Ø¹Ø¨ "1" Ø¨Ù„ Ø±Ù‚Ù… Ø£ÙƒØ¨Ø± ÙŠØ¨Ø¯Ùˆ Ø¹Ø´ÙˆØ§Ø¦ÙŠØ§Ù‹
const OFFSET = 14205; 
const PREFIX = 'ADR'; // Ø¨Ø§Ø¯Ø¦Ø© Ø§Ù„ÙƒÙˆØ¯ (ÙŠÙ…ÙƒÙ†Ùƒ ØªØºÙŠÙŠØ±Ù‡Ø§ Ù„Ø§Ø³Ù… Ù„Ø¹Ø¨ØªÙƒ Ù…Ø«Ù„Ø§ ADR)

/**
 * ØªØ­ÙˆÙŠÙ„ Ø±Ù‚Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø¥Ù„Ù‰ ÙƒÙˆØ¯ Ø¯Ø¹ÙˆØ© Ø£Ù†ÙŠÙ‚
 * Ù…Ø«Ø§Ù„: 1050 -> ADR37X
 */
function encodeReferralCode(userNo) {
    if (!userNo) return null;
    // Ù†Ø³ØªØ®Ø¯Ù… Base36 Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø¥Ù„Ù‰ Ø­Ø±ÙˆÙ ÙˆØ£Ø±Ù‚Ø§Ù… (0-9, A-Z)
    const code = (userNo + OFFSET).toString(36).toUpperCase();
    return `${PREFIX}${code}`;
}

/**
 * ØªØ­ÙˆÙŠÙ„ ÙƒÙˆØ¯ Ø§Ù„Ø¯Ø¹ÙˆØ© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ù„Ø±Ù‚Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨ Ù„ØªØ®Ø²ÙŠÙ†Ù‡
 * Ù…Ø«Ø§Ù„: ADR37X -> 1050
 */
function decodeReferralCode(code) {
    if (!code || !code.startsWith(PREFIX)) return null;
    
    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¨Ø§Ø¯Ø¦Ø©
    const cleanCode = code.replace(PREFIX, '');
    
    // Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¹ÙƒØ³ÙŠ Ù…Ù† Base36 Ø¥Ù„Ù‰ Ø±Ù‚Ù…
    const num = parseInt(cleanCode, 36);
    
    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¥Ø²Ø§Ø­Ø© Ù„Ù†Ø­ØµÙ„ Ø¹Ù„Ù‰ UserNo Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ
    const userNo = num - OFFSET;
    
    return (userNo > 0) ? userNo : null;
}

module.exports = { encodeReferralCode, decodeReferralCode };
^^^^^^^^^^ FILE END: utils\referralCodec.js ^^^^^^^^^^

vvvvvvvvvv FILE START: utils\rewardSystem.js vvvvvvvvvv
const { sql } = require('../config/db');

/**
 * Ø¯Ø§Ù„Ø© Ù„Ø­Ø³Ø§Ø¨ ÙˆÙ…Ù†Ø­ Ù†Ù‚Ø§Ø· Ø§Ù„ÙˆÙ„Ø§Ø¡ Ø¹Ù†Ø¯ Ø§Ù„Ø´Ø±Ø§Ø¡
 * @param {object} request - ÙƒØ§Ø¦Ù† Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„Ù€ Transaction Ø§Ù„Ø­Ø§Ù„ÙŠØ©
 * @param {number} userNo - Ø±Ù‚Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨
 * @param {number} amountSpentGP - Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø°ÙŠ ØµØ±ÙÙ‡ Ø§Ù„Ù„Ø§Ø¹Ø¨
 */
async function rewardPointsOnPurchase(request, userNo, amountSpentGP) {
    try {
        // 1. Ø¬Ù„Ø¨ Ø§Ù„Ù†Ø³Ø¨Ø© Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª (Ù…Ø«Ù„Ø§Ù‹ 0.05 ØªØ¹Ù†ÙŠ 5%)
        // Ù†Ø³ØªØ®Ø¯Ù… request Ø§Ù„Ù…Ù…Ø±Ø± Ø¥Ù„ÙŠÙ†Ø§ Ù„Ù†ÙƒÙˆÙ† Ø¯Ø§Ø®Ù„ Ù†ÙØ³ Ø§Ù„Ù€ Transaction
        const settingRes = await request.query(`SELECT ConfigValue FROM AdrenalineWeb.dbo.Web_Settings WHERE ConfigKey = 'PurchasePointsRatio'`);
        const ratio = settingRes.recordset[0] ? parseFloat(settingRes.recordset[0].ConfigValue) : 0;

        // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù†Ø³Ø¨Ø© 0 Ø£Ùˆ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©ØŒ Ù†ÙˆÙ‚Ù Ø§Ù„Ø¯Ø§Ù„Ø©
        if (ratio <= 0) return; 

        // 2. Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†Ù‚Ø§Ø· (ØªÙ‚Ø±ÙŠØ¨ Ù„Ù„Ø£Ø¯Ù†Ù‰)
        const pointsEarned = Math.floor(amountSpentGP * ratio);

        if (pointsEarned > 0) {
            // 3. Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù†Ù‚Ø§Ø· Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù„Ø§Ø¹Ø¨
            await request.query(`UPDATE AuthDB.dbo.T_Account SET LoyaltyPoints = LoyaltyPoints + ${pointsEarned} WHERE UserNo = ${userNo}`);
            
            // 4. ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© ÙÙŠ Ø§Ù„Ù„ÙˆØ¬ Ù„ÙŠØ¹Ø±Ù Ø§Ù„Ù„Ø§Ø¹Ø¨ Ù…Ù† Ø£ÙŠÙ† Ø¬Ø§Ø¡Øª Ø§Ù„Ù†Ù‚Ø§Ø·
            await request.query(`
                INSERT INTO AdrenalineWeb.dbo.Web_LoyaltyLog (UserNo, PointsSpent, RewardType, RewardAmount, Date)
                VALUES (${userNo}, 0, 'PURCHASE_REWARD', ${pointsEarned}, GETDATE())
            `);
            
            console.log(`[Reward System] User ${userNo} earned ${pointsEarned} points.`);
        }
    } catch (err) {
        console.error('Reward System Error:', err);
        // Ù…Ù„Ø§Ø­Ø¸Ø©: Ù„Ø§ Ù†Ø±Ù…ÙŠ Ø§Ù„Ø®Ø·Ø£ (throw) Ù‡Ù†Ø§ Ù„ÙƒÙŠ Ù„Ø§ Ù†ÙˆÙ‚Ù Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø´Ø±Ø§Ø¡ Ø§Ù„Ø£ØµÙ„ÙŠØ©
        // Ø¥Ø°Ø§ ÙØ´Ù„ Ù…Ù†Ø­ Ø§Ù„Ù†Ù‚Ø§Ø·ØŒ Ø§Ù„Ù„Ø§Ø¹Ø¨ ÙŠØ­ØµÙ„ Ø¹Ù„Ù‰ ØºØ±Ø¶Ù‡ Ø¹Ø§Ø¯ÙŠØŒ ÙˆØ§Ù„Ù†Ù‚Ø§Ø· ÙÙ‚Ø· Ù‡ÙŠ Ø§Ù„ØªÙŠ ØªÙØ´Ù„
    }
}

module.exports = { rewardPointsOnPurchase };
^^^^^^^^^^ FILE END: utils\rewardSystem.js ^^^^^^^^^^
